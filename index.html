<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Studio Personal Trainer</title>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- Tailwind + FullCalendar -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <style>
    .fc-event-title {
      white-space: normal !important;
      line-height: 1.2em;
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, .4);
    }

    body {
      background: linear-gradient(rgba(250, 247, 242, 0.8), rgba(250, 247, 242, 0.8)),
        url('https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?auto=format&fit=crop&w=1920&q=80');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      font-family: 'Inter', sans-serif;
      color: #2d2d2d;
    }

    main, section {
      background-color: rgba(255, 255, 255, 0.65);
      backdrop-filter: blur(5px);
      border-radius: 1rem;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
      padding: 1rem;
    }
	  
	  
	  @media (max-width: 640px) {
  body {
    background-attachment: scroll; /* meno "pesante" su mobile */
  }

  main, section {
    padding: 0.75rem;
    border-radius: 0.75rem;
  }

  /* Gruppo pulsanti admin/trainer pi√π ordinato */
  .admin-btn-group {
    flex-direction: column;
    align-items: stretch;
  }
  .admin-btn-group > button {
    width: 100%;
    justify-content: center;
  }

  /* Toolbar FullCalendar pi√π compatta */
  .fc .fc-toolbar.fc-header-toolbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }

  .fc .fc-toolbar-title {
    font-size: 1.1rem;
  }

  .fc .fc-button {
    padding: 0.25rem 0.4rem;
    font-size: 0.75rem;
  }
}

  
	  
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- ========================= CLIENT: LOGIN ========================= -->
  <section id="clientLogin" class="max-w-md mx-auto mt-20 bg-white p-6 rounded-xl shadow-md">
    <h1 class="text-2xl font-bold text-center text-green-700 mb-4">Area Clienti</h1>
    <form id="clientLoginForm">
      <input id="loginEmail" type="email" placeholder="Email" required class="w-full p-2 border rounded mb-2" />
      <input id="loginPass" type="password" placeholder="Password" required class="w-full p-2 border rounded mb-3" />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Accedi</button>
    </form>
    <form id="clientRegisterForm" class="hidden mt-4 space-y-2">
      <input id="regFirstName" type="text" placeholder="Nome" required class="w-full p-2 border rounded" />
      <input id="regLastName" type="text" placeholder="Cognome" required class="w-full p-2 border rounded" />
      <input id="regPhone" type="tel" placeholder="Telefono" pattern="[0-9+ ]{7,15}" required class="w-full p-2 border rounded" />
      <input id="regEmail" type="email" placeholder="Email" required class="w-full p-2 border rounded" />
      <input id="regPass" type="password" placeholder="Password" required class="w-full p-2 border rounded mb-3" />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Registrati</button>
    </form>
    <form id="resetPasswordForm" class="hidden mt-4">
      <input id="resetEmail" type="email" placeholder="Email per reset" required class="w-full p-2 border rounded mb-3" />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Invia</button>
    </form>
    <p class="text-center text-sm text-gray-500 mt-4">
      <button id="switchToRegister" class="text-green-600 underline">Registrati</button> /
      <button id="switchToLogin" class="text-green-600 underline">Accedi</button>
    </p>
    <p class="text-center text-sm text-gray-500 mt-3">
      <button id="forgotPasswordLink" class="text-green-600 underline">Password dimenticata?</button>
    </p>
    <p class="text-center text-sm text-gray-500 mt-4">
      Sei un istruttore? <a href="#admin" class="text-green-600 underline">Area Admin</a>
    </p>
  </section>

  <!-- ========================= CLIENT: DASHBOARD ========================= -->
  <section id="clientDashboard" class="hidden max-w-5xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">Le mie prenotazioni</h2>
      <div class="space-x-2">
        <button id="newBookingBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Prenota nuovo</button>
        <button id="clientLogout" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">Logout</button>
      </div>
    </div>
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Istruttore</th>
          <th class="p-2 border">Tipo</th>
          <th class="p-2 border">Data</th>
          <th class="p-2 border">Azioni</th>
        </tr>
      </thead>
      <tbody id="apptTableBody"></tbody>
    </table>
    <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-700">Storico Prenotazioni</h3>
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Istruttore</th>
          <th class="p-2 border">Tipo</th>
          <th class="p-2 border">Data</th>
        </tr>
      </thead>
      <tbody id="apptHistoryBody"></tbody>
    </table>
  </section>

  <!-- ========================= CLIENT: PRENOTA ========================= -->
  <section id="clientBooking" class="hidden max-w-4xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between mb-3">
      <h1 class="text-2xl font-bold text-green-700">Prenota appuntamento</h1>
      <button id="backToDashboard" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">Indietro</button>
    </div>
    <div class="space-y-3 mb-3">
      <div>
        <label class="font-semibold">Istruttore</label>
        <select id="instructorSelect" class="border p-2 rounded w-full">
          <option value="ALL">Tutti gli istruttori</option>
        </select>
      </div>
      <div>
        <label class="font-semibold">Tipo allenamento</label>
        <select id="trainingType" class="border p-2 rounded w-full">
          <option value="ALL">Tutti gli allenamenti</option>
          <option value="Pilates">Pilates</option>
          <option value="Funzionale">Funzionale</option>
          <option value="Pesi">Pesi</option>
        </select>
      </div>
      <div>
        <label class="font-semibold">Tipo lezione</label>
        <select id="groupTypeSelect" class="border p-2 rounded w-full">
          <option value="ALL">Tutti</option>
          <option value="INDIVIDUAL">Individuale</option>
          <option value="GROUP">Gruppo</option>
        </select>
      </div>
      <label class="block mt-2 text-sm font-medium">Note per l'istruttore (opzionali):</label>
      <textarea id="clientBookingNotes" class="w-full border rounded p-2" placeholder="Aggiungi una nota..."></textarea>
      <div>
        <label class="font-semibold">Data</label>
        <input type="date" id="bookingDate" class="border p-2 rounded w-full">
      </div>
      <button id="loadSlotsBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 w-full">Mostra orari</button>
    </div>
    <div id="clientCalendar" class="border rounded shadow-sm"></div>
  </section>

  <!-- ========================= ADMIN: LOGIN ========================= -->
  <section id="adminLogin" class="hidden max-w-md mx-auto mt-20 bg-white p-6 rounded-xl shadow-md">
    <h2 class="text-2xl font-bold text-center mb-4 text-green-700">Accesso Admin</h2>
    <form id="adminLoginForm" class="space-y-4">
      <input id="adminEmail" type="email" placeholder="Email" required class="w-full p-2 border rounded" />
      <input id="adminPassword" type="password" placeholder="Password" required class="w-full p-2 border rounded" />
      <button type="submit" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700">Accedi</button>
    </form>
    <p class="mt-4 text-center text-sm text-gray-600">
      <a href="#" id="backToClientLogin" class="text-blue-600 hover:underline">üîô Torna all'accesso clienti</a>
    </p>
  </section>

  <!-- ========================= ADMIN: PANNELLO PRINCIPALE ========================= -->
  <section id="adminPanel" class="hidden max-w-6xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">Gestione Studio</h2>
   <div class="flex flex-wrap gap-2 admin-btn-group">
        <button id="adminNewBookingBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">‚ûï Nuova prenotazione</button>
        <button id="openReport" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">üìä Report</button>
        <button id="openTrainersBtn" class="bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700">Gestione Istruttori</button>
        <button id="openClientsBtn" class="bg-teal-600 text-white px-3 py-1 rounded hover:bg-teal-700">üë• Gestione Clienti</button>
        <button id="openLogsBtn" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">üìú Registro attivit√†</button>
		<button id="adminChangePasswordBtn" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800">Cambia password</button>
        <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Logout</button>
      </div>
    </div>
    <div id="calendarStudio" class="border rounded shadow-sm"></div>
  </section>

	<!-- ========================= ADMIN: MODALE CAMBIO PASSWORD ========================= -->
<div id="adminChangePasswordModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-5 w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Cambia password admin</h3>

    <div class="mb-2">
      <label class="block text-sm font-semibold mb-1">Password attuale</label>
      <input id="adminCurrentPass" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>
    <div class="mb-2">
      <label class="block text-sm font-semibold mb-1">Nuova password</label>
      <input id="adminNewPass" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-semibold mb-1">Conferma nuova password</label>
      <input id="adminNewPass2" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>

    <div class="flex justify-end gap-2">
      <button id="adminChangePasswordCancel"
              class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
        Annulla
      </button>
      <button id="adminChangePasswordConfirm"
              class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
        Salva
      </button>
    </div>
  </div>
</div>

	
	  <!-- ========================= TRAINER: PANNELLO ISTRUTTORE ========================= -->
 <section id="trainerPanel" class="hidden max-w-6xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
  <div class="flex justify-between items-center mb-4">
    <div>
      <h2 class="text-2xl font-bold text-green-700">Calendario Istruttore</h2>
      <p class="mt-1 text-sm text-gray-700">
        Istruttore: <span id="trainerNameLabel" class="font-semibold"></span>
      </p>
    </div>
   <div class="flex gap-2 flex-wrap admin-btn-group">
      <!-- se hai gi√† il tasto Report, lascialo pure -->
      <button id="trainerOpenReport" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
        üìä Report
      </button>

      <!-- üëá nuovo bottone cambio password -->
      <button id="trainerChangePasswordBtn" class="bg-gray-700 text-white px-3 py-1 rounded hover:bg-gray-800">
        Cambia password
      </button>

      <button id="trainerLogoutBtn" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">
        Logout
      </button>
    </div>
  </div>
  <div id="trainerCalendar" class="border rounded shadow-sm"></div>
</section>

<!-- ========================= MODALE DETTAGLI SLOT ISTRUTTORE ========================= -->
<div id="trainerSlotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full space-y-4">
    <h2 class="text-xl font-semibold text-green-700">Dettagli slot</h2>

    <p id="trainerSlotInfo" class="text-gray-700 text-sm"></p>

    <!-- Elenco prenotazioni -->
    <div>
      <h3 class="font-semibold mb-1 text-sm">Prenotazioni presenti</h3>
      <ul id="trainerSlotBookings" class="max-h-48 overflow-y-auto text-sm border rounded p-2 bg-gray-50">
        <li class="text-gray-500 italic">Nessuna prenotazione.</li>
      </ul>
    </div>

    <!-- Aggiungi prenotazione -->
    <div id="trainerAddBookingSection" class="space-y-2 border-t pt-3">
      <h3 class="font-semibold mb-1 text-sm">‚ûï Aggiungi prenotazione</h3>
      <p class="text-xs text-gray-600">Seleziona un cliente gi√† registrato.</p>
      <select id="trainerAddBookingClient" class="border p-2 rounded w-full text-sm"></select>
      <textarea id="trainerAddBookingNotes" rows="2" class="border p-2 rounded w-full text-sm" placeholder="Note (opzionale)"></textarea>
    </div>

    <div class="flex justify-between items-center pt-2">
      <span id="trainerSlotSeatsLabel" class="text-xs text-gray-600"></span>
     <div class="flex gap-2 flex-wrap admin-btn-group">
        <button id="trainerSlotClose" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
          Chiudi
        </button>
        <button id="trainerSlotAddBtn" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
          Salva prenotazione
        </button>
		  <button id="trainerDeleteSlotBtn" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
    üóëÔ∏è Elimina slot
  </button>
      </div>
    </div>
  </div>
</div>

<!-- ========================= MODALE CAMBIO PASSWORD ISTRUTTORE ========================= -->
<div id="trainerChangePasswordModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-5 w-full max-w-sm">
    <h3 class="text-lg font-semibold mb-3">Cambia password</h3>

    <div class="mb-2">
      <label class="block text-sm font-semibold mb-1">Password attuale</label>
      <input id="trainerCurrentPass" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>
    <div class="mb-2">
      <label class="block text-sm font-semibold mb-1">Nuova password</label>
      <input id="trainerNewPass" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>
    <div class="mb-4">
      <label class="block text-sm font-semibold mb-1">Conferma nuova password</label>
      <input id="trainerNewPass2" type="password"
             class="border p-2 rounded w-full text-sm" />
    </div>

    <div class="flex justify-end gap-2">
      <button id="trainerChangePasswordCancel"
              class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400 text-sm">
        Annulla
      </button>
      <button id="trainerChangePasswordConfirm"
              class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
        Salva
      </button>
    </div>
  </div>
</div>
	
  <!-- ========================= ADMIN: ISTRUTTORI ========================= -->
  <section id="adminTrainers" class="hidden max-w-4xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">Gestione Istruttori</h2>
      <button id="backToAdminPanel" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">‚Üê Torna</button>
    </div>
    <div class="mb-6">
     <h3 class="font-semibold mb-2">Aggiungi nuovo istruttore</h3>
<div class="space-y-2">
  <input type="text" id="newTrainerName" placeholder="Nome istruttore" class="w-full p-2 border rounded" />
  <input type="text" id="newTrainerActivities" placeholder="Attivit√† (Pilates, Funzionale, ...)" class="w-full p-2 border rounded" />
  <input id="newTrainerPhone" type="tel" class="border p-2 w-full rounded" placeholder="+39 333 1234567" />
  <input id="newTrainerApiKey" type="text" placeholder="API key / CallMeBot" class="border p-2 rounded w-full" />

  <!-- üëá NUOVI CAMPI per l‚Äôaccesso istruttore -->
  <input id="newTrainerEmail" type="email" placeholder="Email per il login istruttore" class="border p-2 rounded w-full" />
  <input id="newTrainerPassword" type="password" placeholder="Password iniziale istruttore" class="border p-2 rounded w-full mb-2" />

  <button id="addTrainerBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
    Aggiungi istruttore
  </button>
</div>

    </div>
    <h3 class="font-semibold mb-2">Elenco istruttori</h3>
    <table class="w-full text-sm border mb-4">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Nome</th>
          <th class="p-2 border">Attivit√†</th>
          <th class="p-2 border">Telefono</th>
          <th class="p-2 border">Codice CallMeBot</th>
			<th class="p-2 border text-center">Aggiungi pren.</th>
    <th class="p-2 border text-center">Crea slot</th>
    <th class="p-2 border text-center">Elimina slot</th>
			<th class="p-2 border text-center">Sposta slot</th>
    <th class="p-2 border text-center">Azioni</th>
        </tr>
      </thead>
      <tbody id="trainersTableBody"></tbody>
    </table>
  </section>

  <!-- ========================= ADMIN: CLIENTI ========================= -->
  <section id="adminClients" class="hidden max-w-5xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">Gestione Clienti</h2>
      <button id="backToAdminPanelFromClients" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">‚Üê Torna</button>
    </div>
    <div class="flex items-center justify-between mb-4">
      <input type="text" id="searchClientInput" placeholder="üîç Cerca per nome o cognome..." class="p-2 border rounded w-full max-w-sm" />
    </div>
    <table class="w-full text-sm border mb-4">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 border">Nome</th>
          <th class="p-2 border">Cognome</th>
          <th class="p-2 border">Telefono</th>
          <th class="p-2 border">Email</th>
          <th class="p-2 border">Data registrazione</th>
          <th class="p-2 border">Stato</th>
          <th class="p-2 border text-center">Azioni</th>
        </tr>
      </thead>
      <tbody id="clientsTableBody">
        <tr><td colspan="7" class="p-3 text-center text-gray-500">Caricamento...</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ========================= ADMIN: LOGS ========================= -->
  <section id="adminLogs" class="hidden p-4">
    <h2 class="text-xl font-bold mb-4">Registro attivit√†</h2>
    <button id="clearLogsBtn" class="bg-red-600 text-white px-3 py-2 rounded hover:bg-red-700 mb-4">üóëÔ∏è Cancella tutti i log</button>
    <button id="backToAdminFromLogs" class="bg-gray-600 text-white px-3 py-1 rounded mb-4">‚¨Ö Torna al pannello admin</button>
    <table class="w-full text-sm border mt-3">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 border">Data</th>
          <th class="p-2 border">Utente</th>
          <th class="p-2 border">Azione</th>
          <th class="p-2 border">Sezione</th>
          <th class="p-2 border">Dettagli</th>
        </tr>
      </thead>
      <tbody id="logsTableBody"></tbody>
    </table>
  </section>

  <!-- ========================= ADMIN: REPORT ========================= -->
  <section id="adminReport" class="hidden max-w-6xl mx-auto mt-10 bg-white p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-bold text-green-700">Report Personalizzato</h2>
      <div class="flex gap-2 flex-wrap admin-btn-group">
        <button id="backToCalendar" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400">Torna al calendario</button>
        <button id="exportReportPDF" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">üßæ Esporta PDF</button>
      </div>
    </div>
    <div class="flex flex-wrap gap-4 items-center mb-4">
      <div>
        <label class="block text-sm font-semibold mb-1">Istruttore:</label>
        <select id="reportInstructorSelect" class="border p-2 rounded min-w-[200px]">
          <option value="ALL">Tutti</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Data Inizio:</label>
        <input type="date" id="reportStartDate" class="border p-2 rounded">
      </div>
      <div>
        <label class="block text-sm font-semibold mb-1">Data Fine:</label>
        <input type="date" id="reportEndDate" class="border p-2 rounded">
      </div>
      <div class="flex items-end">
        <button id="loadReportBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">üîç Carica Report</button>
      </div>
    </div>
    <table class="w-full text-sm border">
  <thead class="bg-gray-100">
    <tr>
      <th class="p-2 border">Data</th>
      <th class="p-2 border">Ora</th>
      <th class="p-2 border">Istruttore</th>
      <th class="p-2 border">Disciplina</th>
      <th class="p-2 border">Posti</th>
      <th class="p-2 border">Clienti</th>
      <th class="p-2 border">Note cliente</th>
      <th class="p-2 border">Note interne</th>
    </tr>
  </thead>
  <tbody id="reportTableBody"></tbody>
</table>

  </section>

  <!-- ========================= MODALI ========================= -->
  <!-- Conferma prenotazione -->
  <div id="confirmModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full">
      <h2 class="text-lg font-semibold text-green-700 mb-2">Conferma</h2>
      <p id="confirmText" class="text-gray-700 mb-4"></p>
      <div class="flex justify-end space-x-2">
        <button id="cancelBooking" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
        <button id="confirmBooking" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Conferma</button>
      </div>
    </div>
  </div>

  <!-- Modifica prenotazione -->
  <div id="editModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-lg font-semibold text-green-700 mb-3">‚úèÔ∏è Modifica prenotazione</h2>
      <p id="editInfo" class="text-gray-700 mb-4"></p>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="font-semibold block mb-1">Istruttore</label>
          <select id="editInstructor" class="border p-2 rounded w-full"></select>
        </div>
        <div>
          <label class="font-semibold block mb-1">Tipo</label>
          <select id="editType" class="border p-2 rounded w-full">
            <option value="ALL">Tutti gli allenamenti</option>
            <option value="Pilates">Pilates</option>
            <option value="Funzionale">Funzionale</option>
            <option value="Pesi">Pesi</option>
          </select>
        </div>
        <div>
          <label class="font-semibold block mb-1">Data</label>
          <input type="date" id="editDate" class="border p-2 rounded w-full" />
        </div>
      </div>
      <button id="loadEditSlotsBtn" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 w-full mb-4">Mostra orari disponibili</button>
      <p id="editSelection" class="text-sm text-gray-600 mb-2">Nessuno slot selezionato.</p>
      <div id="editCalendar" class="border rounded shadow-sm mb-4"></div>
      <div class="flex justify-end space-x-2">
        <button id="cancelEdit" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
        <button id="confirmEdit" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Salva modifiche</button>
      </div>
    </div>
  </div>

  <!-- Dettagli slot -->
  <div id="bookingDetailModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-lg w-full">
      <h2 class="text-lg font-semibold text-green-700 mb-4">Dettagli Slot</h2>
      <div class="grid grid-cols-2 gap-3 text-gray-700 text-sm">
        <p><strong>Istruttore:</strong> <span id="clientInstrInfo"></span></p>
        <p><strong>Data e Ora:</strong> <span id="clientDateInfo"></span></p>
        <p><strong>Stato:</strong> <span id="clientTypeInfo"></span></p>
        <p>
          <strong>Seleziona prenotazione:</strong>
          <select id="adminApptSelector" class="border p-1 rounded w-full"></select>
        </p>
      </div>
      <h3 class="mt-4 font-semibold text-sm text-gray-700">Partecipanti</h3>
      <ul id="adminParticipantsList" class="text-sm text-gray-700 mt-1 mb-4 max-h-40 overflow-y-auto border rounded p-2 bg-gray-50"></ul>
      <div id="addClientToGroupSection" class="border-t pt-3 mt-3 hidden">
        <h4 class="font-semibold text-sm text-gray-700 mb-2">‚ûï Aggiungi partecipante</h4>
        <div class="flex items-center gap-2">
          <select id="addClientToGroupSelect" class="border p-2 rounded w-full"></select>
          <button id="addClientToGroupBtn" class="bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700 whitespace-nowrap">Aggiungi</button>
        </div>
      </div>
      <div class="flex justify-between mt-2">
        <button id="adminCancelAppt" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Cancella prenotazione</button>
        <div class="space-x-2">
          <button id="closeBookingDetail" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Chiudi</button>
          <button id="adminMoveAppt" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Sposta prenotazione</button>
        </div>
      </div>
      <div class="mt-3">
        <label class="font-semibold">Nota interna:</label>
        <textarea id="adminInternalNote" class="w-full border p-2 rounded mt-1" placeholder="Aggiungi una nota interna..."></textarea>
        <button id="saveAdminInternalNote" class="mt-2 bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">üíæ Salva nota</button>
      </div>
    </div>
  </div>

  <!-- Sposta prenotazione -->
  <div id="adminMoveModal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-lg font-semibold text-green-700 mb-3">Sposta prenotazione</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="font-semibold block mb-1">Istruttore</label>
          <select id="adminMoveInstructor" class="border p-2 rounded w-full"></select>
        </div>
        <div>
          <label class="font-semibold block mb-1">Data</label>
          <input type="date" id="adminMoveDate" class="border p-2 rounded w-full" />
        </div>
        <div class="flex items-end">
          <button id="adminMoveLoadSlots" class="w-full bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Mostra orari</button>
        </div>
      </div>
      <p id="adminMoveSelection" class="text-sm text-gray-600 mb-2">Nessuno slot selezionato.</p>
      <div id="adminMoveCalendar" class="border rounded shadow-sm mb-4"></div>
      <div class="flex justify-end space-x-2">
        <button id="adminMoveCancel" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
        <button id="adminMoveConfirm" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Conferma spostamento</button>
      </div>
    </div>
  </div>

  <!-- Nuova prenotazione admin -->
  <div id="adminNewBookingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-semibold text-green-700 mb-4">‚ûï Crea Prenotazione Manuale</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block font-semibold mb-1">Cliente</label>
          <select id="adminBookingClientSelect" class="border p-2 rounded w-full"></select>
        </div>
        <div>
          <label class="block font-semibold mb-1">Istruttore</label>
          <select id="adminBookingInstructorSelect" class="border p-2 rounded w-full"></select>
        </div>
        <div>
          <label class="block font-semibold mb-1">Data</label>
          <input type="date" id="adminBookingDate" class="border p-2 rounded w-full">
        </div>
      </div>
      <button id="adminBookingLoadSlots" class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 mb-3 w-full">Mostra slot disponibili</button>
      <div id="adminBookingCalendar" class="border rounded shadow-sm mb-4"></div>
      <div class="flex justify-end space-x-2">
        <button id="adminBookingCancel" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
        <button id="adminBookingConfirm" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Conferma Prenotazione</button>
      </div>
    </div>
  </div>

  <!-- Slot libero -->
  <div id="freeSlotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full space-y-4">
      <h2 class="text-lg font-semibold text-green-700">Slot libero</h2>
      <p id="freeSlotInfo" class="text-gray-700"></p>
      <div>
        <label class="block mb-1 font-semibold">Cliente</label>
        <select id="freeSlotClientSelect" class="border p-2 rounded w-full"></select>
      </div>
      <div class="flex justify-end space-x-2">
        <button id="freeSlotCancel" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
        <button id="freeSlotDelete" class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">Elimina Slot</button>
        <button id="freeSlotBook" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Aggiungi Prenotazione</button>
      </div>
    </div>
  </div>

  <!-- Prenotazioni cliente -->
  <div id="clientBookingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg max-w-3xl w-full max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-semibold text-green-700 mb-4">üìÖ Prenotazioni future</h2>
      <p id="clientBookingsName" class="text-gray-700 mb-3 font-medium"></p>
      <table class="w-full text-sm border mb-4">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">Data</th>
            <th class="p-2 border">Ora</th>
            <th class="p-2 border">Istruttore</th>
            <th class="p-2 border">Attivit√†</th>
          </tr>
        </thead>
        <tbody id="clientBookingsTableBody">
          <tr><td colspan="9" class="p-3 text-center text-gray-500">Caricamento...</td></tr>
        </tbody>
      </table>
      <div class="flex justify-end">
        <button id="closeClientBookings" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Chiudi</button>
      </div>
    </div>
  </div>

  <!-- ========================= SCRIPT ========================= -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, getDocs, query, where, updateDoc, deleteDoc, runTransaction,setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
   import { 
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  sendPasswordResetEmail,
  updatePassword,
  EmailAuthProvider,
  reauthenticateWithCredential
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCsczpMpMc-vW10Qc21Exh6MX1lr-b38Ig",
      authDomain: "fitwebstudio-88a7a.firebaseapp.com",
      projectId: "fitwebstudio-88a7a",
      storageBucket: "fitwebstudio-88a7a.firebasestorage.app",
      messagingSenderId: "800497947730",
      appId: "1:800497947730:web:f220c422e56dbadbccbb8b",
      measurementId: "G-3VB030LFEC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
	  // App secondaria per creare utenti (cos√¨ l'admin non viene disconnesso)
const secondaryApp = initializeApp(firebaseConfig, "secondary");
const secondaryAuth = getAuth(secondaryApp);


    /* ========================================================= */
    /* FUNZIONI LOG                                              */
    /* ========================================================= */
    async function writeLog(actionType, section, details = "") {
      try {
        const user = auth.currentUser;
        const email = user?.email || "unknown";
        await addDoc(collection(db, "logs"), {
          userEmail: email,
          actionType,
          section,
          details,
          timestamp: new Date().toISOString()
        });
      } catch (err) {
        console.error("Errore scrittura log:", err);
      }
    }

    /* ========================================================= */
    /* FUNZIONI UTILIT√Ä                                          */
    /* ========================================================= */
    function showSection(id) {
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      document.getElementById(id)?.classList.remove("hidden");
    }

    function toISO(v) {
      if (!v) return null;
      if (typeof v === "string") return v;
      if (v.toDate) return v.toDate().toISOString();
      if (v.seconds) return new Date(v.seconds * 1000).toISOString();
      return null;
    }

    const remainingSeats = slot => (slot?.maxSeats ?? 1) - (slot?.bookedCount ?? 0);

    const withDefaults = slot => ({
      ...slot,
      maxSeats: slot?.maxSeats ?? 1,
      bookedCount: slot?.bookedCount ?? 0,
      booked: slot?.booked ?? ((slot?.bookedCount ?? 0) >= (slot?.maxSeats ?? 1))
    });

    /* ========================================================= */
    /* ROUTING E AUTH                                            */
    /* ========================================================= */
    window.addEventListener("DOMContentLoaded", () => {
      /* -------------------------------------------------------- */
      /* SWITCH FORM LOGIN/REGISTER/RESET                         */
      /* -------------------------------------------------------- */
      document.getElementById("switchToRegister")?.addEventListener("click", () => {
        document.getElementById("clientLoginForm").classList.add("hidden");
        document.getElementById("clientRegisterForm").classList.remove("hidden");
        document.getElementById("resetPasswordForm").classList.add("hidden");
      });
      document.getElementById("switchToLogin")?.addEventListener("click", () => {
        document.getElementById("clientRegisterForm").classList.add("hidden");
        document.getElementById("clientLoginForm").classList.remove("hidden");
        document.getElementById("resetPasswordForm").classList.add("hidden");
      });
      document.getElementById("forgotPasswordLink")?.addEventListener("click", () => {
        document.getElementById("clientLoginForm").classList.add("hidden");
        document.getElementById("resetPasswordForm").classList.remove("hidden");
      });

	  
	  // ---------------- CAMBIO PASSWORD ISTRUTTORE ----------------
const trainerChangePasswordModal = document.getElementById("trainerChangePasswordModal");
const trainerChangePasswordBtn = document.getElementById("trainerChangePasswordBtn");
const trainerChangePasswordCancel = document.getElementById("trainerChangePasswordCancel");
const trainerChangePasswordConfirm = document.getElementById("trainerChangePasswordConfirm");

function openTrainerChangePasswordModal() {
  if (!trainerChangePasswordModal) return;
  document.getElementById("trainerCurrentPass").value = "";
  document.getElementById("trainerNewPass").value = "";
  document.getElementById("trainerNewPass2").value = "";
  trainerChangePasswordModal.classList.remove("hidden");
  trainerChangePasswordModal.classList.add("flex");
}

function closeTrainerChangePasswordModal() {
  if (!trainerChangePasswordModal) return;
  trainerChangePasswordModal.classList.add("hidden");
  trainerChangePasswordModal.classList.remove("flex");
}

trainerChangePasswordBtn?.addEventListener("click", () => {
  openTrainerChangePasswordModal();
});

trainerChangePasswordCancel?.addEventListener("click", () => {
  closeTrainerChangePasswordModal();
});

// Salva nuova password (con re-auth)
trainerChangePasswordConfirm?.addEventListener("click", async () => {
  const currentPass = document.getElementById("trainerCurrentPass").value.trim();
  const newPass = document.getElementById("trainerNewPass").value.trim();
  const newPass2 = document.getElementById("trainerNewPass2").value.trim();

  if (!currentPass || !newPass || !newPass2) {
    return alert("‚ö†Ô∏è Compila tutti i campi.");
  }

  if (newPass !== newPass2) {
    return alert("‚ö†Ô∏è Le nuove password non coincidono.");
  }

  if (newPass.length < 6) {
    return alert("‚ö†Ô∏è La password deve avere almeno 6 caratteri.");
  }

  const user = auth.currentUser;
  if (!user || !user.email) {
    return alert("‚ùå Utente non trovato. Riprova effettuando di nuovo l'accesso.");
  }

  try {
    // 1) RE-AUTH con la password attuale
    const cred = EmailAuthProvider.credential(user.email, currentPass);
    await reauthenticateWithCredential(user, cred);

    // 2) Aggiorna la password
    await updatePassword(user, newPass);

    alert("‚úÖ Password aggiornata con successo.");
    closeTrainerChangePasswordModal();
  } catch (err) {
    console.error("Errore cambio password trainer:", err);
    if (err.code === "auth/wrong-password") {
      alert("‚ùå La password attuale non √® corretta.");
    } else if (err.code === "auth/too-many-requests") {
      alert("‚ùå Troppi tentativi non riusciti. Attendi qualche minuto e riprova.");
    } else {
      alert("‚ùå Errore durante il cambio password: " + (err.message || err.code));
    }
  }
});

	  
	  
	  // Cancellazione prenotazione dal pannello istruttore
document.getElementById("trainerSlotBookings")?.addEventListener("click", async (e) => {
  const btn = e.target.closest(".trainer-cancel-btn");
  if (!btn) return;

  const apptId = btn.dataset.apptId;
  const slotId = btn.dataset.slotId;
  if (!apptId || !slotId) return;

  if (!confirm("Vuoi cancellare questa prenotazione?")) return;

  try {
    await runTransaction(db, async (transaction) => {
      const apptRef = doc(db, "appointments", apptId);
      const slotRef = doc(db, "availabilities", slotId);

      const apptSnap = await transaction.get(apptRef);
      const slotSnap = await transaction.get(slotRef);

      if (!apptSnap.exists()) throw new Error("Prenotazione non trovata.");
      if (!slotSnap.exists()) throw new Error("Slot non trovato.");

      const slot = withDefaults(slotSnap.data());
      const newCount = Math.max(0, (slot.bookedCount || 0) - 1);

      transaction.update(apptRef, {
        cancelled: true,
        cancelledBy: "trainer",
        cancelledAt: new Date().toISOString()
      });

      transaction.update(slotRef, {
        bookedCount: newCount,
        booked: newCount >= slot.maxSeats
      });
    });

    alert("Prenotazione cancellata.");
    // chiudo il modal: il calendario si aggiorna da solo via onSnapshot
    const modal = document.getElementById("trainerSlotModal");
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  } catch (err) {
    console.error("Errore cancellazione prenotazione (trainer):", err);
    alert("Errore durante la cancellazione: " + err.message);
  }
});

	  
      /* -------------------------------------------------------- */
      /* REGISTRAZIONE CLIENTE                                    */
      /* -------------------------------------------------------- */
      document.getElementById("clientRegisterForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const firstName = document.getElementById("regFirstName").value.trim();
        const lastName = document.getElementById("regLastName").value.trim();
        const phone = document.getElementById("regPhone").value.trim();
        const email = document.getElementById("regEmail").value.trim();
        const pass = document.getElementById("regPass").value.trim();

        if (!firstName || !lastName || !phone || !email || !pass) return alert("‚ö†Ô∏è Compila tutti i campi obbligatori.");

        try {
  const cred = await createUserWithEmailAndPassword(auth, email, pass);
  console.log("‚úÖ Auth creato:", cred.user.uid);

  const docRef = 
  await addDoc(collection(db, "clients"), {
  uid: cred.user.uid, // ‚úÖ usa direttamente l'UID da createUserWithEmailAndPassword
  firstName,
  lastName,
  phone,
  email,
  status: "pending",
  createdAt: new Date().toISOString()
});
// Forza logout immediato
await signOut(auth);

// Messaggio e redirect
alert("‚úÖ Registrazione inviata! Il tuo account √® in attesa di approvazione.");
document.getElementById("clientRegisterForm").reset();
showSection("clientLogin");
  console.log("‚úÖ Documento clients creato:", docRef.id);
} catch (err) {
  console.error("‚ùå Errore durante registrazione:", err);
  alert("Errore registrazione: " + err.message);
  return;
}
      });

      /* -------------------------------------------------------- */
      /* LOGIN CLIENTE                                            */
      /* -------------------------------------------------------- */
      document.getElementById("clientLoginForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const email = document.getElementById("loginEmail").value.trim();
          const pass = document.getElementById("loginPass").value.trim();
          await signInWithEmailAndPassword(auth, email, pass);
        } catch (err) {
          alert(err.message);
        }
      });

      /* -------------------------------------------------------- */
      /* RESET PASSWORD                                           */
      /* -------------------------------------------------------- */
      document.getElementById("resetPasswordForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const email = document.getElementById("resetEmail").value.trim();
          await sendPasswordResetEmail(auth, email);
          alert("Email di reset inviata.");
          document.getElementById("resetPasswordForm").reset();
          showSection("clientLogin");
        } catch (err) {
          alert(err.message);
        }
      });

      /* -------------------------------------------------------- */
      /* ADMIN LOGIN                                              */
      /* -------------------------------------------------------- */
      document.getElementById("adminLoginForm")?.addEventListener("submit", async (e) => {
        e.preventDefault();
        try {
          const email = document.getElementById("adminEmail").value.trim();
          const pass = document.getElementById("adminPassword").value.trim();
          const cred = await signInWithEmailAndPassword(auth, email, pass);
          const adminDoc = await getDoc(doc(db, "admins", email));
          if (!adminDoc.exists()) {
            await signOut(auth);
            alert("‚ùå Accesso negato: non sei un amministratore.");
            return;
          }
          location.hash = "#admin";
        } catch (err) {
          alert("Errore login admin: " + err.message);
        }
      });

      /* -------------------------------------------------------- */
      /* LOGOUT                                                   */
      /* -------------------------------------------------------- */
      document.getElementById("logoutBtn")?.addEventListener("click", async () => {
        await signOut(auth);
        location.hash = "";
        showSection("clientLogin");
      });

      document.getElementById("clientLogout")?.addEventListener("click", async () => {
        await signOut(auth);
        location.hash = "";
        showSection("clientLogin");
      });
	  
	        document.getElementById("trainerLogoutBtn")?.addEventListener("click", async () => {
        await signOut(auth);
        location.hash = "";
        showSection("clientLogin");
      });

// ---------------- CAMBIO PASSWORD ADMIN ----------------
const adminChangePasswordModal = document.getElementById("adminChangePasswordModal");
const adminChangePasswordBtn = document.getElementById("adminChangePasswordBtn");
const adminChangePasswordCancel = document.getElementById("adminChangePasswordCancel");
const adminChangePasswordConfirm = document.getElementById("adminChangePasswordConfirm");

function openAdminChangePasswordModal() {
  if (!adminChangePasswordModal) return;
  document.getElementById("adminCurrentPass").value = "";
  document.getElementById("adminNewPass").value = "";
  document.getElementById("adminNewPass2").value = "";
  adminChangePasswordModal.classList.remove("hidden");
  adminChangePasswordModal.classList.add("flex");
}

function closeAdminChangePasswordModal() {
  if (!adminChangePasswordModal) return;
  adminChangePasswordModal.classList.add("hidden");
  adminChangePasswordModal.classList.remove("flex");
}

adminChangePasswordBtn?.addEventListener("click", () => {
  openAdminChangePasswordModal();
});

adminChangePasswordCancel?.addEventListener("click", () => {
  closeAdminChangePasswordModal();
});

adminChangePasswordConfirm?.addEventListener("click", async () => {
  const currentPass = document.getElementById("adminCurrentPass").value.trim();
  const newPass = document.getElementById("adminNewPass").value.trim();
  const newPass2 = document.getElementById("adminNewPass2").value.trim();

  if (!currentPass || !newPass || !newPass2) {
    return alert("‚ö†Ô∏è Compila tutti i campi.");
  }

  if (newPass !== newPass2) {
    return alert("‚ö†Ô∏è Le nuove password non coincidono.");
  }

  if (newPass.length < 6) {
    return alert("‚ö†Ô∏è La password deve avere almeno 6 caratteri.");
  }

  const user = auth.currentUser;
  if (!user || !user.email) {
    return alert("‚ùå Utente admin non trovato. Effettua di nuovo l'accesso.");
  }

  try {
    // 1) Re-auth con password attuale
    const cred = EmailAuthProvider.credential(user.email, currentPass);
    await reauthenticateWithCredential(user, cred);

    // 2) Aggiorna la password
    await updatePassword(user, newPass);

    alert("‚úÖ Password admin aggiornata con successo.");
    closeAdminChangePasswordModal();
  } catch (err) {
    console.error("Errore cambio password admin:", err);
    if (err.code === "auth/wrong-password") {
      alert("‚ùå La password attuale non √® corretta.");
    } else if (err.code === "auth/too-many-requests") {
      alert("‚ùå Troppi tentativi non riusciti. Attendi qualche minuto e riprova.");
    } else {
      alert("‚ùå Errore durante il cambio password: " + (err.message || err.code));
    }
  }
});

      /* -------------------------------------------------------- */
      /* ROUTING                                                  */
      /* -------------------------------------------------------- */
          async function route() {
        const user = auth.currentUser;

        // ====================== AREA ADMIN / ISTRUTTORE ======================
        if (location.hash === "#admin") {
          if (user) {
            const adminDocSnap = await getDoc(doc(db, "admins", user.email));
            if (!adminDocSnap.exists()) {
              // Non √® n√© admin n√© istruttore
              alert("‚ùå Accesso negato: non sei un amministratore/istruttore.");
              showSection("clientLogin");
              location.hash = "";
              return;
            }

            const adminData = adminDocSnap.data() || {};
            const role = adminData.role || "admin";

            if (role === "trainer") {
              // PROFILO ISTRUTTORE
              const trainerName =
                adminData.trainerName || adminData.name || user.email;

              const label = document.getElementById("trainerNameLabel");
              if (label) label.textContent = trainerName;

              showSection("trainerPanel");
              initTrainerCalendar(trainerName); // nuova funzione che creiamo sotto
            } else {
              // PROFILO ADMIN COMPLETO
              showSection("adminPanel");
              initAdminCalendars();
            }
          } else {
            // Non loggato: mostra form admin
            showSection("adminLogin");
          }
          return;
        }

        // ====================== AREA CLIENTI (come prima) ======================
        if (user) {
          // Se √® admin/istruttore ma hash √® vuota, lo rimando al pannello corretto
          const adminDoc = await getDoc(doc(db, "admins", user.email));
          if (adminDoc.exists()) {
            const role = (adminDoc.data() || {}).role || "admin";
            if (role === "trainer" || role === "admin") {
              location.hash = "#admin";
              return;
            }
          }

          const qClient = query(collection(db, "clients"), where("uid", "==", user.uid));
          const snap = await getDocs(qClient);
          if (snap.empty) {
            alert("Profilo cliente non trovato. Contatta lo studio.");
            await signOut(auth);
            showSection("clientLogin");
            return;
          }
          const clientDoc = snap.docs[0].data();
          if (clientDoc.status !== "approved") {
            alert("Il tuo account √® in attesa di approvazione.");
            document.getElementById("clientRegisterForm").reset();
            showSection("clientLogin");
            return;
          }
          showSection("clientDashboard");
          loadClientAppointments(user.email);
        } else {
          showSection("clientLogin");
        }
      }


      window.addEventListener("hashchange", route);
      onAuthStateChanged(auth, () => route());
      route();

      /* ========================================================= */
      /* ADMIN: CALENDARIO PRINCIPALE                              */
      /* ========================================================= */
      let adminUnsub = null;
      let adminCal = null;

	  
	  const isMobile = window.matchMedia("(max-width: 768px)").matches;
const defaultCalendarView = isMobile ? "timeGridDay" : "timeGridWeek";

	  
      async function initAdminCalendars() {
        const calEl = document.getElementById("calendarStudio");
        if (!calEl) return;
        calEl.innerHTML = "";
        if (adminCal) {
          adminCal.destroy();
          adminCal = null;
        }

        adminCal = new FullCalendar.Calendar(calEl, {
initialView: defaultCalendarView,
handleWindowResize: true,
dayMaxEvents: true,
height: "auto",
          selectable: true,
          editable: true,
          height: "auto",
          locale: 'it',
          slotMinTime: "07:00:00",
          slotMaxTime: "22:00:00",
          slotDuration: "00:15:00",
          slotLabelInterval: "01:00",
          nowIndicator: true,
          expandRows: true,
          dayMaxEventRows: 6,
          contentHeight: "auto",
          stickyHeaderDates: true,
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "timeGridWeek,timeGridDay"
          },
          slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
          eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
          dayHeaderFormat: { weekday: 'short', day: 'numeric' },
          eventAllow: (dropInfo, draggedEvent) => {
            const data = draggedEvent.extendedProps;
            return !(data.bookedCount > 0);
          },
          eventDrop: async (info) => {
            const slotRef = doc(db, "availabilities", info.event.id);
            const snap = await getDoc(slotRef);
            if (!snap.exists()) {
              alert("Errore: slot non trovato.");
              info.revert();
              return;
            }
            const v = snap.data();
            if (v.bookedCount > 0) {
              alert("‚ùå Non puoi spostare uno slot con prenotazioni attive!");
              info.revert();
              return;
            }
            try {
              await updateDoc(slotRef, {
                start: info.event.start.toISOString(),
                end: info.event.end?.toISOString() || new Date(info.event.start.getTime() + 60 * 60000).toISOString(),
                modifiedAt: new Date().toISOString()
              });
              writeLog("move-slot", "calendar", formatSlotLog({
                instructor: v.instructor,
                type: v.type,
                start: info.event.start.toISOString(),
                maxSeats: v.maxSeats
              }, "Spostato slot"));
            } catch (err) {
              console.error("Errore update slot dopo drop:", err);
              alert("Errore aggiornamento slot.");
              info.revert();
            }
          },
          eventResize: async (info) => {
            const data = info.event.extendedProps;
            if (data.bookedCount > 0) {
              alert("‚ùå Non puoi modificare la durata di slot con prenotazioni attive!");
              info.revert();
              return;
            }
            try {
              const slotRef = doc(db, "availabilities", info.event.id);
              await updateDoc(slotRef, {
                start: info.event.start.toISOString(),
                end: info.event.end.toISOString(),
                modifiedAt: new Date().toISOString()
              });
              writeLog("resize-slot", "calendar", formatSlotLog({
                instructor: info.event.title.split(" ‚Äì ")[0],
                type: data.type,
                start: info.event.start.toISOString(),
                maxSeats: data.maxSeats
              }, "Modificata durata slot"));
            } catch (err) {
              console.error("Errore update slot dopo resize:", err);
              alert("Errore salvataggio durata.");
              info.revert();
            }
          },
          select: async (info) => {
            const modalDiv = document.getElementById("slotCreationModal");
            const instrSel = document.getElementById("adminModalInstructorSelect");
            const actSel = document.getElementById("adminModalActivitySelect");
            const durInput = document.getElementById("modalDuration");
            const seatsInp = document.getElementById("modalMaxSeats");

            if (!modalDiv || !instrSel || !actSel || !durInput || !seatsInp) {
              console.error("Elementi del modale mancanti");
              return;
            }

            modalDiv.dataset.startIso = info.start.toISOString();
            modalDiv.dataset.endIso = info.end?.toISOString() || "";

            const defDurationMin = Math.max(1, Math.round(((info.end - info.start) || 3600000) / 60000));
            durInput.value = defDurationMin;
            if (!seatsInp.value) seatsInp.value = 1;

            instrSel.innerHTML = `<option value="">Caricamento...</option>`;
            actSel.innerHTML = `<option value="">Seleziona istruttore prima</option>`;

            let trainerList = [];
            try {
              const snap = await getDocs(collection(db, "trainers"));
              trainerList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
              instrSel.innerHTML = trainerList.length === 0
                ? `<option value="">(nessun istruttore)</option>`
                : `<option value="">-- Seleziona istruttore --</option>` +
                  trainerList.map(t => `<option value="${t.name}">${t.name}</option>`).join("");
            } catch (err) {
              console.error("Errore caricamento istruttori:", err);
              instrSel.innerHTML = `<option value="">Errore caricamento</option>`;
            }

            instrSel.onchange = (e) => {
              const trainer = trainerList.find(t => t.name === e.target.value);
              actSel.innerHTML = trainer?.activities?.length
                ? `<option value="">-- Seleziona attivit√† --</option>` +
                  trainer.activities.map(a => `<option value="${a}">${a}</option>`).join("")
                : `<option value="">(nessuna attivit√† disponibile)</option>`;
            };

            modalDiv.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");

            if (modalDiv._createAbortCtrl) modalDiv._createAbortCtrl.abort();
            const abortCtrl = new AbortController();
            modalDiv._createAbortCtrl = abortCtrl;

            const createBtn = document.getElementById("modalCreateBtn");
            const cancelBtn = document.getElementById("modalCancelBtn");

            cancelBtn?.addEventListener("click", () => {
              modalDiv.classList.add("hidden");
              document.body.classList.remove("overflow-hidden");
              info.view.calendar.unselect();
              abortCtrl.abort();
            }, { signal: abortCtrl.signal });

            createBtn?.addEventListener("click", async () => {
              const instructor = instrSel.value.trim();
              const activity = actSel.value.trim();
              const duration = parseInt(durInput.value, 10) || defDurationMin || 60;
              const maxSeats = Math.max(1, parseInt(seatsInp.value, 10) || 1);

              if (!instructor) return alert("Seleziona un istruttore.");
              if (!activity) return alert("Seleziona un'attivit√†.");

              const startIso = modalDiv.dataset.startIso;
              if (!startIso) return alert("Selezione non valida.");

              const start = new Date(startIso);
              const end = new Date(start.getTime() + duration * 60000);

              try {
                await addDoc(collection(db, "availabilities"), {
                  instructor,
                  type: activity,
                  start: start.toISOString(),
                  end: end.toISOString(),
                  maxSeats,
                  bookedCount: 0,
                  booked: false,
                  deleted: false,
                  createdAt: new Date().toISOString(),
                  isGroup: maxSeats > 1
                });

                writeLog("create-slot", "calendar", formatSlotLog({
                  instructor,
                  type: activity,
                  start: start.toISOString(),
                  maxSeats
                }, "Creato slot"));

                alert("‚úÖ Slot creato con successo!");
                modalDiv.classList.add("hidden");
                document.body.classList.remove("overflow-hidden");
                info.view.calendar.unselect();
                abortCtrl.abort();
              } catch (err) {
                console.error("Errore creazione slot:", err);
                alert("Errore creazione slot.");
              }
            }, { signal: abortCtrl.signal });
          },
        eventClick: async (info) => {
  const slotId = info.event.id;
  const slotRef = doc(db, "availabilities", slotId);
  const s = await getDoc(slotRef);
  if (!s.exists()) return;

  const v = withDefaults(s.data());

  if (v.bookedCount === 0) {
    const modal = document.getElementById("freeSlotModal");
    const infoEl = document.getElementById("freeSlotInfo");
    const clientSel = document.getElementById("freeSlotClientSelect");

    infoEl.textContent = `${v.instructor} ‚Äì ${v.type || "Allenamento"} ‚Ä¢ ${new Date(toISO(v.start)).toLocaleString("it-IT")}`;

    clientSel.innerHTML = `<option>Caricamento...</option>`;
    try {
      const snap = await getDocs(collection(db, "clients"));
      clientSel.innerHTML = `<option value="">-- Seleziona cliente --</option>` +
        snap.docs.map(c => {
          const d = c.data();
          return `<option value="${d.email}">${d.firstName} ${d.lastName}</option>`;
        }).join("");
    } catch {
      clientSel.innerHTML = `<option value="">Errore caricamento</option>`;
    }

    modal.dataset.slotId = slotId;
    modal.classList.remove("hidden");
    document.body.classList.add("overflow-hidden");
    return;
  }
            const qAp = query(collection(db, "appointments"), where("slotId", "==", slotId), where("cancelled", "==", false));
            const sAp = await getDocs(qAp);
            const list = sAp.docs.map(d => ({ id: d.id, ...d.data() }));

            const clientsSnap = await getDocs(collection(db, "clients"));
            const clientsMap = {};
            clientsSnap.forEach(c => {
              const data = c.data();
              if (data.email) clientsMap[data.email.trim().toLowerCase()] = `${data.firstName || ""} ${data.lastName || ""}`.trim();
            });

            const enriched = list.map(a => ({
              ...a,
              displayName: clientsMap[a.email?.trim().toLowerCase()] || a.client || a.email || "-"
            }));

            const sel = document.getElementById("adminApptSelector");
            sel.innerHTML = enriched
              .map(a => `<option value="${a.id}">${a.displayName} ‚Äî ${new Date(toISO(a.start)).toLocaleString()}</option>`)
              .join("");

            document.getElementById("adminParticipantsList").innerHTML = enriched.map(a => `
              <li class="py-2 border-b">
                <div class="flex justify-between">
                  <div><strong>${a.displayName}</strong><span class="text-gray-500 text-xs">(${a.email})</span></div>
                  <span class="text-xs text-gray-600">${a.type || "-"}</span>
                </div>
                ${a.notes ? `<div class="mt-1 text-sm text-blue-700 bg-blue-50 p-2 rounded">üìù ${a.notes}</div>` : `<div class="mt-1 text-sm text-gray-500 italic">Nessuna nota</div>`}
              </li>
            `).join("");

            document.getElementById("adminInternalNote").value = enriched[0].adminNote || "";

            const addSection = document.getElementById("addClientToGroupSection");
            const addSelect = document.getElementById("addClientToGroupSelect");
            const addBtn = document.getElementById("addClientToGroupBtn");

            if (v.bookedCount < v.maxSeats) {
              addSection.classList.remove("hidden");
              addSelect.innerHTML = `<option>Caricamento...</option>`;
              const snapClients = await getDocs(collection(db, "clients"));
              const allClients = snapClients.docs.map(c => c.data());
              const bookedEmails = new Set(enriched.map(e => e.email?.trim().toLowerCase()));
              const availableClients = allClients.filter(c => !bookedEmails.has(c.email?.trim().toLowerCase()));
              addSelect.innerHTML = `<option value="">-- Seleziona cliente --</option>` +
                availableClients.map(c => `<option value="${c.email}">${c.firstName} ${c.lastName} (${c.email})</option>`).join("");

              addBtn.onclick = async () => {
                const email = addSelect.value;
                if (!email) return alert("Seleziona un cliente.");
                try {
                  await runTransaction(db, async (transaction) => {
                    const slotRef = doc(db, "availabilities", slotId);
                    const sSnap = await transaction.get(slotRef);
                    if (!sSnap.exists()) throw new Error("Slot non trovato.");
                    const slot = withDefaults(sSnap.data());
                    if (slot.bookedCount >= slot.maxSeats) throw new Error("Slot pieno.");
                    transaction.update(slotRef, {
                      bookedCount: slot.bookedCount + 1,
                      booked: (slot.bookedCount + 1) >= slot.maxSeats
                    });
                    const newApptRef = doc(collection(db, "appointments"));
                    transaction.set(newApptRef, {
                      client: email,
                      email,
                      instructor: slot.instructor,
                      type: slot.type,
                      start: toISO(slot.start),
                      end: toISO(slot.end),
                      slotId,
                      cancelled: false,
                      createdAt: new Date().toISOString()
                    });
                  });
                  alert("Cliente aggiunto!");
                  addSection.classList.add("hidden");
                  document.getElementById("bookingDetailModal").classList.add("hidden");
                  document.body.classList.remove("overflow-hidden");
                } catch (err) {
                  alert("‚ùå " + err.message);
                }
              };
            } else {
              addSection.classList.add("hidden");
            }

            document.getElementById("clientInstrInfo").textContent = v.instructor;
            document.getElementById("clientDateInfo").textContent = new Date(toISO(v.start)).toLocaleString("it-IT");
            document.getElementById("clientTypeInfo").textContent = `${v.type || "-"} ‚Ä¢ Posti: ${v.bookedCount}/${v.maxSeats}`;

            const modal = document.getElementById("bookingDetailModal");
            modal.dataset.slotId = slotId;
            modal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
          }
        });

        adminCal.render();

        if (adminUnsub) adminUnsub();
        adminUnsub = onSnapshot(collection(db, "availabilities"), async (snap) => {
          const apptsSnap = await getDocs(query(collection(db, "appointments"), where("cancelled", "==", false)));
          const apptsBySlot = {};
          apptsSnap.forEach(a => {
            const data = a.data();
            const slotId = data.slotId;
            if (!apptsBySlot[slotId]) apptsBySlot[slotId] = [];
            apptsBySlot[slotId].push(data);
          });

          const events = [];
          snap.forEach(d => {
            const v = withDefaults(d.data());
            if (v.deleted) return;
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            const slotId = d.id;
            const slotAppts = apptsBySlot[slotId] || [];
            const hasNotes = slotAppts.some(a => (a.notes && a.notes.trim()) || (a.adminNote && a.adminNote.trim()));
            const remaining = remainingSeats(v);
            const color = v.bookedCount > 0 ? (remaining > 0 ? "#f59e0b" : "#dc2626") : "#16a34a";
            const icon = hasNotes ? " üìù" : "";
            events.push({
              id: slotId,
              title: `${v.instructor} ‚Äì ${v.type || "Allenamento"} (liberi ${remaining}/${v.maxSeats})${icon}`,
              start: s,
              end: e,
              color,
              extendedProps: {
                bookedCount: v.bookedCount,
                maxSeats: v.maxSeats,
                hasNotes
              }
            });
          });
          adminCal.removeAllEvents();
          adminCal.addEventSource(events);
        });
      }
	  
	  
	/* ========================================================= */
/* TRAINER: CALENDARIO ISTRUTTORE (DETTAGLI + PRENOTAZIONI)  */
/* ========================================================= */
let trainerCal = null;
let trainerUnsub = null;
let trainerSlotModalSlotId = null;

let trainerPermissions = {
  addBooking: true,
  addSlot: true,
  deleteSlot: true,
	moveSlot: true
};

window.trainerPermissions = trainerPermissions;
	  
	  
	  


async function initTrainerCalendar(trainerName) {
  const calEl = document.getElementById("trainerCalendar");
  if (!calEl) return;

  /* ---------- 1. CARICO I PERMESSI DA "trainers" ---------- */
  try {
    const snap = await getDocs(
      query(collection(db, "trainers"), where("name", "==", trainerName))
    );
    if (!snap.empty) {
      const data = snap.docs[0].data();
      trainerPermissions = {
        addBooking: data.allowAddBooking !== false,
        addSlot:    data.allowAddSlot    !== false,
        deleteSlot: data.allowDeleteSlot !== false,
		  moveSlot:     data.allowMoveSlot     !== false 
      };
    } else {
      trainerPermissions = { addBooking: true, addSlot: true, deleteSlot: true,  moveSlot: true };
    }
	  window.trainerPermissions = trainerPermissions;
  } catch (err) {
    console.error("Errore caricamento permessi istruttore:", err);
    trainerPermissions = { addBooking: true, addSlot: true, deleteSlot: true, moveSlot: true };
	  window.trainerPermissions = trainerPermissions;
  }

  /* ---------- 2. INIZIALIZZO CALENDARIO ---------- */
  calEl.innerHTML = "";
  if (trainerCal) {
    trainerCal.destroy();
    trainerCal = null;
  }

  trainerCal = new FullCalendar.Calendar(calEl, {
   initialView: defaultCalendarView,
handleWindowResize: true,
dayMaxEvents: true,
height: "auto",

    selectable: true,
    editable: trainerPermissions.moveSlot,
    height: "auto",
    locale: "it",
    slotMinTime: "07:00:00",
    slotMaxTime: "22:00:00",
    slotDuration: "00:15:00",
    slotLabelInterval: "01:00",
    nowIndicator: true,
    expandRows: true,
    dayMaxEventRows: 6,
    contentHeight: "auto",
    stickyHeaderDates: true,
    headerToolbar: {
      left: "prev,next today",
      center: "title",
      right: "timeGridWeek,timeGridDay"
    },
    slotLabelFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
    eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
    dayHeaderFormat: { weekday: "short", day: "numeric" },

	      // ---------- drag & drop / resize slot istruttore ----------
eventAllow: (dropInfo, draggedEvent) => {
  // usa i permessi dell'istruttore
  if (!trainerPermissions.moveSlot) return false;

  const data = draggedEvent.extendedProps || {};
  // vieto lo spostamento se lo slot ha gi√† prenotazioni
  if (data.bookedCount > 0) return false;
  // (opzionale) blocco lo spostamento nel passato
  if (dropInfo.start < new Date()) return false;
  return true;
},

eventDrop: async (info) => {
  if (!trainerPermissions.moveSlot) {
    alert("Non hai i permessi per spostare gli slot.");
    info.revert();
    return;
  }


      try {
        const slotRef = doc(db, "availabilities", info.event.id);
        const snap = await getDoc(slotRef);
        if (!snap.exists()) {
          alert("Errore: slot non trovato.");
          info.revert();
          return;
        }

        const slot = withDefaults(snap.data());

        if (slot.bookedCount > 0) {
          alert("‚ùå Non puoi spostare uno slot con prenotazioni attive!");
          info.revert();
          return;
        }

        await updateDoc(slotRef, {
          start: info.event.start.toISOString(),
          end:
            info.event.end?.toISOString() ||
            new Date(info.event.start.getTime() + 60 * 60000).toISOString(),
          modifiedAt: new Date().toISOString()
        });

        // log opzionale, cos√¨ vedi cosa succede lato trainer
        writeLog(
          "move-slot-trainer",
          "trainer-calendar",
          formatSlotLog(
            {
              instructor: slot.instructor,
              type: slot.type,
              start: info.event.start.toISOString(),
              maxSeats: slot.maxSeats
            },
            "Spostato slot istruttore"
          )
        );
      } catch (err) {
        console.error("Errore update slot dopo drop (trainer):", err);
        alert("Errore aggiornamento slot.");
        info.revert();
      }
    },

    eventResize: async (info) => {
  if (!trainerPermissions.moveSlot) {
    alert("Non hai i permessi per modificare la durata degli slot.");
    info.revert();
    return;
  }
      try {
        const slotRef = doc(db, "availabilities", info.event.id);
        const snap = await getDoc(slotRef);
        if (!snap.exists()) {
          alert("Errore: slot non trovato.");
          info.revert();
          return;
        }

        const slot = withDefaults(snap.data());

        if (slot.bookedCount > 0) {
          alert("‚ùå Non puoi modificare la durata di uno slot con prenotazioni attive!");
          info.revert();
          return;
        }

        await updateDoc(slotRef, {
          start: info.event.start.toISOString(),
          end: info.event.end.toISOString(),
          modifiedAt: new Date().toISOString()
        });

        writeLog(
          "resize-slot-trainer",
          "trainer-calendar",
          formatSlotLog(
            {
              instructor: slot.instructor,
              type: slot.type,
              start: info.event.start.toISOString(),
              maxSeats: slot.maxSeats
            },
            "Modificata durata slot istruttore"
          )
        );
      } catch (err) {
        console.error("Errore update slot dopo resize (trainer):", err);
        alert("Errore salvataggio durata.");
        info.revert();
      }
    },

	  
    /* ---------- creazione slot ---------- */
    select: (info) => {
      if (!trainerPermissions.addSlot) {
        alert("Non hai i permessi per creare nuovi slot. Contatta l'amministratore.");
        trainerCal.unselect();
        return;
      }
      openTrainerQuickSlotModal(info);
    },

    /* ---------- click su slot: dettagli + prenotazioni ---------- */
    eventClick: async (info) => {
      const slotId = info.event.id;

      // 1) Leggo lo slot
      const slotSnap = await getDoc(doc(db, "availabilities", slotId));
      if (!slotSnap.exists()) return;
      const slot = withDefaults(slotSnap.data());

      // sicurezza: solo slot dell'istruttore corrente
      if (slot.instructor !== trainerName) {
        alert("Questo slot non appartiene al tuo profilo.");
        return;
      }

      // 2) Prenotazioni di questo slot
      const qAp = query(
        collection(db, "appointments"),
        where("slotId", "==", slotId),
        where("cancelled", "==", false)
      );
      const apSnap = await getDocs(qAp);
      const appts = apSnap.docs.map(d => ({ id: d.id, ...d.data() }));

      // 3) Mappa clienti per mostrare nome/cognome
      const clientsSnap = await getDocs(collection(db, "clients"));
      const clientsMap = {};
      clientsSnap.forEach(c => {
        const cd = c.data();
        if (cd.email) {
          clientsMap[cd.email.trim().toLowerCase()] =
            `${cd.firstName || ""} ${cd.lastName || ""}`.trim();
        }
      });

      // 4) Riferimenti DOM del modal istruttore
      const modal    = document.getElementById("trainerSlotModal");
      const infoEl   = document.getElementById("trainerSlotInfo");
      const listEl   = document.getElementById("trainerSlotBookings");
      const seatsEl  = document.getElementById("trainerSlotSeatsLabel");
      const addSec   = document.getElementById("trainerAddBookingSection");
      const addSel   = document.getElementById("trainerAddBookingClient");
      const addNotes = document.getElementById("trainerAddBookingNotes");
      const delBtn   = document.getElementById("trainerDeleteSlotBtn");

      modal.dataset.slotId = slotId;

      const startStr = slot.start
        ? new Date(toISO(slot.start)).toLocaleString("it-IT")
        : "";
      infoEl.textContent = `${slot.instructor} ‚Äì ${slot.type || "Allenamento"} ‚Ä¢ ${startStr}`;

      const remaining = remainingSeats(slot);
      seatsEl.textContent = `Posti occupati ${slot.bookedCount}/${slot.maxSeats} ‚Ä¢ liberi: ${remaining}`;

      const slotDate = slot.start ? new Date(toISO(slot.start)) : null;
      const isPast   = slotDate && slotDate < new Date();

      // 5) Lista prenotazioni
      if (appts.length === 0) {
        listEl.innerHTML = `<li class="text-gray-500 italic">Nessuna prenotazione.</li>`;
      } else {
        listEl.innerHTML = appts.map(a => {
          const mail = (a.email || "").trim().toLowerCase();
          const displayName = clientsMap[mail] || a.client || a.email || "-";
          const notes = a.notes
            ? `<div class="mt-1 text-xs text-blue-700">Note cliente: ${a.notes}</div>`
            : "";
          const adminNote = a.adminNote
            ? `<div class="mt-1 text-xs text-gray-500 italic">Nota interna: ${a.adminNote}</div>`
            : "";

          const actionHtml = !isPast
            ? `<button
                  class="trainer-cancel-btn bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600"
                  data-appt-id="${a.id}"
                  data-slot-id="${slotId}"
               >
                 Cancella
               </button>`
            : `<span class="text-xs text-gray-400">Lezione passata</span>`;

          return `
            <li class="py-2 border-b">
              <div class="flex justify-between items-start">
                <div>
                  <strong>${displayName}</strong>
                  <span class="text-xs text-gray-500 ml-1">${a.email || ""}</span>
                  ${notes}
                  ${adminNote}
                </div>
                <div class="text-right space-y-1">
                  <div class="text-xs text-gray-600">${a.type || "-"}</div>
                  ${actionHtml}
                </div>
              </div>
            </li>
          `;
        }).join("");
      }

      // 6) Sezione "Aggiungi prenotazione"
      addNotes.value = "";
      if (!trainerPermissions.addBooking || remaining <= 0 || isPast) {
        addSec.classList.add("hidden");
        if (remaining <= 0) {
          addSel.innerHTML = `<option value="">Slot pieno</option>`;
        }
      } else {
        addSec.classList.remove("hidden");

        const bookedEmails = new Set(
          appts
            .map(a => a.email?.trim().toLowerCase())
            .filter(Boolean)
        );

        const allClients = clientsSnap.docs.map(c => c.data());
        const availableClients = allClients.filter(c => {
          const em = c.email?.trim().toLowerCase();
          return em && !bookedEmails.has(em);
        });

        if (availableClients.length === 0) {
          addSel.innerHTML = `<option value="">Nessun cliente disponibile</option>`;
        } else {
          addSel.innerHTML =
            `<option value="">-- Seleziona cliente --</option>` +
            availableClients
              .map(c => `<option value="${c.email}">${c.firstName} ${c.lastName} (${c.email})</option>`)
              .join("");
        }
      }

      // 7) Bottone "Elimina slot" (solo futuro, senza prenotazioni, con permesso)
      if (delBtn) {
        if (!trainerPermissions.deleteSlot || isPast || appts.length > 0) {
          delBtn.classList.add("hidden");
          delBtn.removeAttribute("data-slot-id");
        } else {
          delBtn.classList.remove("hidden");
          delBtn.dataset.slotId = slotId;
        }
      }

      // 8) Mostro il modal
      modal.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }
  });

  trainerCal.render();

  /* ---------- 3. ASCOLTO SLOT ISTRUTTORE IN TEMPO REALE ---------- */
  if (trainerUnsub) trainerUnsub();
  trainerUnsub = onSnapshot(collection(db, "availabilities"), async (snap) => {
    const apptsSnap = await getDocs(
      query(collection(db, "appointments"), where("cancelled", "==", false))
    );
    const apptsBySlot = {};
    apptsSnap.forEach(a => {
      const data = a.data();
      const slotId = data.slotId;
      if (!slotId) return;
      if (!apptsBySlot[slotId]) apptsBySlot[slotId] = [];
      apptsBySlot[slotId].push(data);
    });

    const events = [];
    snap.forEach(d => {
      const v = withDefaults(d.data());
      if (v.deleted) return;
      if (v.instructor !== trainerName) return;

      const s = toISO(v.start);
      const e = toISO(v.end);
      if (!s || !e) return;

      const slotId = d.id;
      const slotAppts = apptsBySlot[slotId] || [];
      const hasNotes = slotAppts.some(a =>
        (a.notes && a.notes.trim()) || (a.adminNote && a.adminNote.trim())
      );
      const remaining = remainingSeats(v);

      let color = "#16a34a";
      if (v.bookedCount > 0) {
        color = remaining > 0 ? "#f59e0b" : "#dc2626";
      }
      const icon = hasNotes ? " üìù" : "";

      events.push({
        id: slotId,
        title: `${v.type || "Allenamento"} (liberi ${remaining}/${v.maxSeats})${icon}`,
        start: s,
        end: e,
        color,
        extendedProps: {
          bookedCount: v.bookedCount,
          maxSeats: v.maxSeats,
          hasNotes
        }
      });
    });

    trainerCal.removeAllEvents();
    trainerCal.addEventSource(events);
  });
}

/* ---------- MODALE CREAZIONE SLOT RAPIDA ISTRUTTORE ---------- */
let trainerSelectionInfo = null;

async function loadTrainerDisciplines() {
  const trainerName = document.getElementById("trainerNameLabel")?.textContent?.trim();
  if (!trainerName) return;
  const snap = await getDocs(
    query(collection(db, "trainers"), where("name", "==", trainerName))
  );
  if (snap.empty) return;
  const data = snap.docs[0].data();
  const acts = (data.activities || []).filter(Boolean);
  const sel = document.getElementById("trainerQuickDiscipline");
  sel.innerHTML = acts.length
    ? acts.map(a => `<option value="${a}">${a}</option>`).join("")
    : `<option value="">Nessuna disciplina configurata</option>`;
}

function openTrainerQuickSlotModal(selectionInfo) {
  trainerSelectionInfo = selectionInfo;

  // durata di default
  let defaultDuration = 60;

  if (selectionInfo && selectionInfo.start && selectionInfo.end) {
    const diffMs = selectionInfo.end.getTime() - selectionInfo.start.getTime();

    if (diffMs > 0) {
      const rawMinutes = diffMs / 60000; // ms ‚Üí minuti

      // se l'utente ha selezionato un solo "slot" da 15'
      // lo interpretiamo come "clic singolo" ‚Üí 60 minuti
      if (rawMinutes <= 15) {
        defaultDuration = 60;
      } else {
        // altrimenti usiamo la durata selezionata, arrotondata ai 15'
        defaultDuration = Math.round(rawMinutes / 15) * 15;
      }
    }
  }

  document.getElementById("trainerQuickDuration").value = String(defaultDuration);
  document.getElementById("trainerQuickMaxSeats").value = "1";
  loadTrainerDisciplines();
  document.getElementById("trainerQuickSlotModal").classList.remove("hidden");
  document.body.classList.add("overflow-hidden");
}



document.getElementById("trainerQuickCancel")?.addEventListener("click", () => {
  document.getElementById("trainerQuickSlotModal").classList.add("hidden");
  document.body.classList.remove("overflow-hidden");
  trainerCal.unselect();
});

document.getElementById("trainerQuickSave")?.addEventListener("click", async () => {
  if (!trainerPermissions.addSlot) {
    alert("Non hai i permessi per creare nuovi slot.");
    return;
  }

  const discipline = document.getElementById("trainerQuickDiscipline").value.trim();
  const duration   = parseInt(document.getElementById("trainerQuickDuration").value, 10);
  const maxSeats   = parseInt(document.getElementById("trainerQuickMaxSeats").value, 10);

  if (!discipline || !duration || !maxSeats || maxSeats < 1) {
    alert("Compila tutti i campi.");
    return;
  }

  const trainerName = document.getElementById("trainerNameLabel")?.textContent?.trim();
  if (!trainerName) return alert("Nome istruttore non trovato.");
  if (!trainerSelectionInfo) return alert("Selezione non valida.");

  const start = trainerSelectionInfo.start.toISOString();
  const end   = new Date(trainerSelectionInfo.start.getTime() + duration * 60000).toISOString();

  try {
    await addDoc(collection(db, "availabilities"), {
      instructor: trainerName,
      type: discipline,
      start,
      end,
      maxSeats,
      bookedCount: 0,
      booked: false,
      deleted: false,
      createdAt: new Date().toISOString(),
      isGroup: maxSeats > 1
    });
    alert("‚úÖ Slot creato!");
    document.getElementById("trainerQuickSlotModal").classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
    trainerCal.unselect();
  } catch (err) {
    console.error("Errore creazione slot istruttore:", err);
    alert("‚ùå Errore durante la creazione.");
  }
});
      /* ========================================================= */
      /* CLIENT: PRENOTAZIONI                                      */
      /* ========================================================= */
      function loadClientAppointments(email) {
        const body = document.getElementById("apptTableBody");
        const now = new Date().toISOString();
        const qAppt = query(collection(db, "appointments"), where("email", "==", email), where("cancelled", "==", false));
        onSnapshot(qAppt, (snap) => {
          const future = [];
          const past = [];
          snap.forEach(d => {
            const v = d.data();
            const startISO = toISO(v.start);
            if (!startISO) return;
            const entry = {
              id: d.id,
              instructor: v.instructor,
              type: v.type || "-",
              date: new Date(startISO).toLocaleString(),
              slotId: v.slotId,
              isGroup: v.isGroup === true
            };
            if (new Date(startISO) < new Date()) past.push(entry);
            else future.push(entry);
          });

          body.innerHTML = future.length ? future.map(a => `
            <tr>
              <td class="p-2 border">${a.instructor}</td>
              <td class="p-2 border">${a.type} <span class="text-xs text-gray-600">(${a.isGroup ? "Gruppo" : "Individuale"})</span></td>
              <td class="p-2 border">${a.date}</td>
              <td class="p-2 border text-center space-x-1">
                <button data-id="${a.id}" data-slot="${a.slotId}" class="edit bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">‚úèÔ∏è</button>
                <button data-id="${a.id}" data-slot="${a.slotId}" class="cancel bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è</button>
              </td>
            </tr>
          `).join("") : `<tr><td colspan="9" class="p-3 text-center text-gray-500">Nessuna prenotazione futura.</td></tr>`;

          const history = document.getElementById("apptHistoryBody");
          history.innerHTML = past.length ? past.map(a => `
            <tr>
              <td class="p-2 border">${a.instructor}</td>
              <td class="p-2 border">${a.type} <span class="text-xs text-gray-600">(${a.isGroup ? "Gruppo" : "Individuale"})</span></td>
              <td class="p-2 border">${a.date}</td>
            </tr>
          `).join("") : `<tr><td colspan="3" class="p-3 text-center text-gray-400">Nessuna prenotazione passata.</td></tr>`;
        });
      }

      /* ========================================================= */
      /* CLIENT: CANCELLA / MODIFICA PRENOTAZIONE                  */
      /* ========================================================= */
      document.getElementById("apptTableBody")?.addEventListener("click", async (e) => {
        const cancelBtn = e.target.closest(".cancel");
        if (cancelBtn) {
          if (!confirm("Vuoi cancellare questa prenotazione?")) return;
          const apptId = cancelBtn.dataset.id;
          const slotId = cancelBtn.dataset.slot;
          const user = auth.currentUser;
          try {
            let slotData = null;
            let apptData = null;
            await runTransaction(db, async (transaction) => {
              const apptRef = doc(db, "appointments", apptId);
              const apptSnap = await transaction.get(apptRef);
              if (!apptSnap.exists()) throw new Error("Prenotazione non trovata.");
              const slotRef = doc(db, "availabilities", slotId);
              const slotSnap = await transaction.get(slotRef);
              if (!slotSnap.exists()) throw new Error("Slot non trovato.");
              const slot = withDefaults(slotSnap.data());
              const appt = apptSnap.data();
              const newCount = Math.max(0, (slot.bookedCount || 0) - 1);
              transaction.update(apptRef, { cancelled: true });
              transaction.update(slotRef, {
                bookedCount: newCount,
                booked: newCount >= slot.maxSeats
              });
              slotData = slot;
              apptData = appt;
            });
            alert("Prenotazione cancellata.");
            let clientFullName = sessionStorage.getItem("clientName") || user.email;
            try {
              const qClient = query(collection(db, "clients"), where("email", "==", user.email));
              const snapClient = await getDocs(qClient);
              if (!snapClient.empty) {
                const c = snapClient.docs[0].data();
                clientFullName = `${c.firstName || ""} ${c.lastName || ""}`.trim() || clientFullName;
              }
            } catch (err) {
              console.warn("Errore recupero nome cliente:", err);
            }
            const date = new Date(toISO(slotData.start)).toLocaleDateString("it-IT");
            const time = new Date(toISO(slotData.start)).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
            const notesText = apptData?.notes?.trim() || "Nessuna";
            const msg = `‚ùå Prenotazione cancellata dal cliente
üë§ Cliente: ${clientFullName}
üìß Email: ${user.email}
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${slotData.type || "Allenamento"}
üìù Note: ${notesText}
üë®‚Äçüè´ Istruttore: ${slotData.instructor}
üïí Data: ${date} alle ${time}`;
            await sendWhatsAppToStudio(msg);
            const trainerCancelMsg = `‚ùå Prenotazione cancellata dal cliente
üë§ Cliente: ${clientFullName}
üìß Email: ${user.email}
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${slotData.type || "Allenamento"}
üìù Note: ${notesText}
üïí Data: ${date} alle ${time}`;
            await sendWhatsAppToTrainer(slotData.instructor, trainerCancelMsg);
          } catch (err) {
            alert("Errore durante la cancellazione: " + err.message);
          }
          return;
        }

        const editBtn = e.target.closest(".edit");
        if (editBtn) {
          openEditModal(editBtn.dataset.id, editBtn.dataset.slot);
        }
      });

      /* ========================================================= */
      /* CLIENT: NUOVA PRENOTAZIONE                                */
      /* ========================================================= */
      let selectedSlot = null;
      let selectedType = null;
      let selectedInstructor = null;
      let selectedGroupType = "ALL";

      document.getElementById("newBookingBtn")?.addEventListener("click", async () => {
        await populateInstructors(document.getElementById("instructorSelect"));
        document.getElementById("instructorSelect").value = "ALL";
        document.getElementById("trainingType").value = "ALL";
        showSection("clientBooking");
      });

      document.getElementById("backToDashboard")?.addEventListener("click", () => showSection("clientDashboard"));

      document.getElementById("loadSlotsBtn")?.addEventListener("click", () => {
        const date = document.getElementById("bookingDate").value;
        const type = document.getElementById("trainingType").value;
        const inst = document.getElementById("instructorSelect").value;
        const groupType = document.getElementById("groupTypeSelect").value;
        if (!date) return alert("Seleziona una data.");
        selectedType = type;
        selectedInstructor = inst;
        selectedGroupType = groupType;
        initClientCalendar(date, inst);
      });

      async function populateInstructors(selectEl) {
        if (!selectEl) return;
        selectEl.innerHTML = `<option value="">Caricamento...</option>`;
        try {
          const trainersSnap = await getDocs(collection(db, "trainers"));
          const trainerList = trainersSnap.docs.map(doc => doc.data().name);
          selectEl.innerHTML = trainerList.length === 0
            ? `<option value="ALL">Nessun istruttore disponibile</option>`
            : `<option value="ALL">Tutti gli istruttori</option>` +
              trainerList.map(name => `<option value="${name}">${name}</option>`).join("");
        } catch (err) {
          console.error("Errore caricamento istruttori:", err);
          selectEl.innerHTML = `<option value="ALL">(Errore caricamento)</option>`;
        }
      }

      async function initClientCalendar(date, instructor) {
        const calEl = document.getElementById("clientCalendar");
        calEl.innerHTML = "";
        const user = auth.currentUser;
        let userBookings = [];
        if (user) {
          const qUserAppointments = query(collection(db, "appointments"), where("email", "==", user.email), where("cancelled", "==", false));
          const apptSnap = await getDocs(qUserAppointments);
          apptSnap.forEach(a => {
            const v = a.data();
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            if (s.slice(0, 10) === date) {
              userBookings.push({
                slotId: v.slotId,
                start: new Date(s),
                end: new Date(e)
              });
            }
          });
        }

        function overlaps(aStart, aEnd, bStart, bEnd) {
          return (aStart < bEnd) && (bStart < aEnd);
        }

        const cal = new FullCalendar.Calendar(calEl, {
       initialView: "timeGridDay",

          initialDate: date,
          allDaySlot: false,
          height: "auto",
          locale: 'it',
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "timeGridDay"
          },
          slotMinTime: "07:00:00",
          slotMaxTime: "22:00:00",
          slotLabelFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
          eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
          eventClick: (info) => {
            const evStart = new Date(info.event.start);
            const evEnd = new Date(info.event.end);
            if (userBookings.some(b => b.slotId === info.event.id)) {
              alert("Hai gi√† prenotato questo slot.");
              return;
            }
            const isOverlapping = userBookings.some(b => overlaps(evStart, evEnd, b.start, b.end));
            if (isOverlapping) {
              alert("Hai gi√† una prenotazione nello stesso intervallo orario.");
              return;
            }
            selectedSlot = info.event.id;
            fetchSlotTypeAndShowConfirm(info);
          }
        });

        cal.render();

        const q = query(collection(db, "availabilities"), where("deleted", "==", false));
        onSnapshot(q, (snap) => {
          cal.removeAllEvents();
          snap.forEach((d) => {
            const v = withDefaults(d.data());
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            const sameDay = new Date(s).toISOString().slice(0, 10) === date;
            const rem = remainingSeats(v);
            const instOK = instructor === "ALL" || v.instructor === instructor;
            const typeOK = selectedType === "ALL" || (v.type || "") === selectedType;
            const groupOK = selectedGroupType === "ALL" ||
              (selectedGroupType === "INDIVIDUAL" && v.isGroup === false) ||
              (selectedGroupType === "GROUP" && v.isGroup === true);
            if (!instOK || !typeOK || !groupOK) return;

            const slotStart = new Date(s);
            const slotEnd = new Date(e);
            const isUserBooked = userBookings.some(b => b.slotId === d.id);
            let isOverlapping = false;
            if (!isUserBooked) {
              isOverlapping = userBookings.some(b => overlaps(slotStart, slotEnd, b.start, b.end));
            }
            let color = "#16a34a";
            if (isUserBooked) color = "#2563eb";
            else if (isOverlapping) color = "#f87171";
            else if (rem <= 0) color = "#9ca3af";

            cal.addEvent({
              id: d.id,
              title: `${v.instructor} ‚Äì ${v.type || "Allenamento"} ‚Äì ${v.isGroup ? "Gruppo" : "Individuale"} (${rem} liberi)` +
                (isUserBooked ? " ‚Äì (Prenotato da te)" : isOverlapping ? " ‚Äì (Sovrapposto)" : ""),
              start: s,
              end: e,
              color: color
            });
          });
        });

        async function fetchSlotTypeAndShowConfirm(info) {
          let slotType = "Allenamento";
          try {
            const slotRef = doc(db, "availabilities", selectedSlot);
            const snap = await getDoc(slotRef);
            if (snap.exists()) slotType = snap.data().type || "Allenamento";
          } catch (err) {
            console.error("Errore nel recupero tipo slot:", err);
          }
          const parts = info.event.title.split("‚Äì").map(p => p.trim());
          const instructorName = parts[0] || "";
          const activityType = slotType;
          const date = info.event.start.toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit", year: "numeric" });
          const time = info.event.start.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
          document.getElementById("confirmText").textContent = `Confermi ${activityType} con ${instructorName} il ${date} alle ${time}?`;
          document.getElementById("confirmModal").classList.remove("hidden");
        }

        document.getElementById("confirmBooking")?.addEventListener("click", async () => {
          const user = auth.currentUser;
          if (!user || !selectedSlot) return alert("Errore utente o slot.");
          const slotRef = doc(db, "availabilities", selectedSlot);
          try {
            await runTransaction(db, async (transaction) => {
              const sSnap = await transaction.get(slotRef);
              if (!sSnap.exists()) throw new Error("Slot non trovato.");
              const slot = withDefaults(sSnap.data());
              if (slot.bookedCount >= slot.maxSeats) throw new Error("Slot pieno.");
              transaction.update(slotRef, {
                bookedCount: slot.bookedCount + 1,
                booked: (slot.bookedCount + 1) >= slot.maxSeats
              });
              const notes = document.getElementById("clientBookingNotes")?.value.trim() || "";
              const newApptRef = doc(collection(db, "appointments"));
              transaction.set(newApptRef, {
                client: sessionStorage.getItem("clientName") || user.email,
                email: user.email,
                instructor: slot.instructor,
                type: slot.type || "Allenamento",
                start: toISO(slot.start),
                end: toISO(slot.end),
                slotId: selectedSlot,
                notes: notes,
                cancelled: false,
                createdAt: new Date().toISOString(),
                isGroup: slot.isGroup === true
              });
            });
            alert("Prenotazione completata!");
            document.getElementById("confirmModal").classList.add("hidden");
            showSection("clientDashboard");
            const slotSnap = await getDoc(slotRef);
            const slot = slotSnap.data();
            let clientFullName = sessionStorage.getItem("clientName") || user.email;
            try {
              const qClient = query(collection(db, "clients"), where("email", "==", user.email));
              const snapClient = await getDocs(qClient);
              if (!snapClient.empty) {
                const c = snapClient.docs[0].data();
                clientFullName = `${c.firstName || ""} ${c.lastName || ""}`.trim() || clientFullName;
              }
            } catch (err) {
              console.warn("Errore recupero nome cliente:", err);
            }
            const date = new Date(toISO(slot.start)).toLocaleDateString("it-IT", { day: "2-digit", month: "2-digit", year: "numeric" });
            const time = new Date(toISO(slot.start)).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
            const notesText = (document.getElementById("clientBookingNotes")?.value.trim() || "").trim() || "Nessuna";
            const msg = `üìÖ Nuova prenotazione ricevuta!
üë§ Cliente: ${clientFullName}
üìß Email: ${user.email}
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${slot.type || "Allenamento"}
üìù Note: ${notesText}
üë®‚Äçüè´ Istruttore: ${slot.instructor}
üïí Data: ${date} alle ${time}`;
            await sendWhatsAppToStudio(msg);
            const trainerMsg = `üìÖ Nuova prenotazione confermata!
üë§ Cliente: ${clientFullName}
üìß Email: ${user.email}
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${slot.type || "Allenamento"}
üìù Note: ${notesText}
üïí Data: ${date} alle ${time}`;
            await sendWhatsAppToTrainer(slot.instructor, trainerMsg);
          } catch (err) {
            alert(err.message);
          }
        });

        document.getElementById("cancelBooking")?.addEventListener("click", () => {
          document.getElementById("confirmModal").classList.add("hidden");
        });
      }

      /* ========================================================= */
      /* CLIENT: MODIFICA APPUNTAMENTO                             */
      /* ========================================================= */
      let editApptId = null;
      let oldSlotId = null;
      let editCalendar = null;
      let selectedNewSlot = null;
      let chosenInstructor = null;

      async function openEditModal(apptId, prevSlotId) {
        editApptId = apptId;
        oldSlotId = prevSlotId;
        const apptRef = doc(db, "appointments", apptId);
        const snap = await getDoc(apptRef);
        if (!snap.exists()) return alert("Appuntamento non trovato.");
        const v = snap.data();
        await populateInstructors(document.getElementById("editInstructor"));
        document.getElementById("editInstructor").value = v.instructor || "";
        document.getElementById("editType").value = "ALL";
        document.getElementById("editDate").value = toISO(v.start).slice(0, 10);
        document.getElementById("editInfo").textContent = `Modifica appuntamento con ${v.instructor} (${v.type}) del ${new Date(toISO(v.start)).toLocaleString()}.`;
        document.getElementById("editSelection").textContent = "Nessuno slot selezionato.";
        document.getElementById("editModal").classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        selectedNewSlot = null;
      }

      document.getElementById("cancelEdit")?.addEventListener("click", () => {
        document.getElementById("editModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      });

      document.getElementById("loadEditSlotsBtn")?.addEventListener("click", async () => {
        const date = document.getElementById("editDate").value;
        chosenInstructor = document.getElementById("editInstructor").value;
        const selectedEditType = document.getElementById("editType").value;
        if (!date || !chosenInstructor || !selectedEditType) return alert("Compila tutti i filtri.");
        const calEl = document.getElementById("editCalendar");
        calEl.innerHTML = "";
        const confirmBtn = document.getElementById("confirmEdit");
        confirmBtn.disabled = true;
        confirmBtn.classList.add("opacity-50", "cursor-not-allowed");

        const user = auth.currentUser;
        let userBookings = [];
        if (user) {
          const qUser = query(collection(db, "appointments"), where("email", "==", user.email), where("cancelled", "==", false));
          const snapUser = await getDocs(qUser);
          snapUser.forEach(a => {
            const v = a.data();
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            const d = s.slice(0, 10);
            if (d !== date || a.id === editApptId) return;
            userBookings.push({
              slotId: v.slotId,
              start: new Date(s),
              end: new Date(e)
            });
          });
        }

        function overlaps(aStart, aEnd, bStart, bEnd) {
          return (aStart < bEnd) && (bStart < aEnd);
        }

        let prev = null;
        editCalendar = new FullCalendar.Calendar(calEl, {
       initialView: "timeGridDay",

          initialDate: date,
          allDaySlot: false,
          height: "auto",
          locale: 'it',
          slotMinTime: "07:00:00",
          slotMaxTime: "22:00:00",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "timeGridDay"
          },
          eventClick: (info) => {
            const evStart = new Date(info.event.start);
            const evEnd = new Date(info.event.end);
            if (info.event.id === oldSlotId) return alert("Questo √® lo slot che hai gi√† prenotato.");
            const isOverlapping = userBookings.some(b => overlaps(evStart, evEnd, b.start, b.end));
            if (isOverlapping) return alert("Hai gi√† una prenotazione in questo intervallo orario.");
            if (prev) prev.setProp("color", prev._originalColor || "#16a34a");
            prev = info.event;
            prev._originalColor = info.event.backgroundColor;
            info.event.setProp("color", "#2563eb");
            selectedNewSlot = info.event.id;
            confirmBtn.disabled = false;
            confirmBtn.classList.remove("opacity-50", "cursor-not-allowed");
            document.getElementById("editSelection").textContent = `Selezionato: ${info.event.title} ‚Äî ${info.event.start.toLocaleString()}`;
          }
        });

        editCalendar.render();

        const q = query(collection(db, "availabilities"), where("deleted", "==", false));
        onSnapshot(q, snap => {
          editCalendar.removeAllEvents();
          snap.forEach(d => {
            const v = withDefaults(d.data());
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            const sameDay = s.slice(0, 10) === date;
            const rem = remainingSeats(v);
            const instOK = chosenInstructor === "ALL" || v.instructor === chosenInstructor;
            const typeOK = selectedEditType === "ALL" || (v.type || "") === selectedEditType;
            if (!instOK || !typeOK) return;

            const slotStart = new Date(s);
            const slotEnd = new Date(e);
            const isUserBooked = (d.id === oldSlotId);
            let isOverlapping = false;
            if (!isUserBooked) {
              isOverlapping = userBookings.some(b => overlaps(slotStart, slotEnd, b.start, b.end));
            }

            let color = "#16a34a";
            if (isUserBooked) color = "#2563eb";
            else if (isOverlapping) color = "#f87171";
            else if (rem <= 0) color = "#9ca3af";

            editCalendar.addEvent({
              id: d.id,
              title: `${v.instructor} ‚Äì ${v.type || "Allenamento"} ‚Äì ${v.isGroup ? "Gruppo" : "Individuale"} (${rem} liberi)` +
                (isUserBooked ? " ‚Äì (Attuale)" : isOverlapping ? " ‚Äì (Sovrapposto)" : ""),
              start: s,
              end: e,
              color: color
            });
          });
        });
      });

      document.getElementById("confirmEdit")?.addEventListener("click", async () => {
        const user = auth.currentUser;
        if (!editApptId || !selectedNewSlot) return alert("Seleziona uno slot.");
        try {
          await runTransaction(db, async (transaction) => {
            const apptRef = doc(db, "appointments", editApptId);
            const apptSnap = await transaction.get(apptRef);
            if (!apptSnap.exists()) throw new Error("Prenotazione non trovata.");
            const oldRef = doc(db, "availabilities", oldSlotId);
            const newRef = doc(db, "availabilities", selectedNewSlot);
            const oldSnap = await transaction.get(oldRef);
            const newSnap = await transaction.get(newRef);
            if (!oldSnap.exists()) throw new Error("Vecchio slot inesistente.");
            if (!newSnap.exists()) throw new Error("Nuovo slot inesistente.");
            const oldSlot = withDefaults(oldSnap.data());
            const newSlot = withDefaults(newSnap.data());
            if (remainingSeats(newSlot) <= 0) throw new Error("Il nuovo slot √® pieno.");
            const updatedOldCount = Math.max(0, oldSlot.bookedCount - 1);
            const updatedNewCount = newSlot.bookedCount + 1;
            transaction.update(oldRef, {
              bookedCount: updatedOldCount,
              booked: updatedOldCount >= oldSlot.maxSeats
            });
            transaction.update(newRef, {
              bookedCount: updatedNewCount,
              booked: updatedNewCount >= newSlot.maxSeats
            });
            transaction.update(apptRef, {
              instructor: newSlot.instructor,
              start: toISO(newSlot.start),
              end: toISO(newSlot.end),
              slotId: selectedNewSlot,
              type: newSlot.type || "Allenamento",
              isGroup: newSlot.isGroup === true,
              modifiedAt: new Date().toISOString()
            });
          });

          try {
            const slotOldRef = doc(db, "availabilities", oldSlotId);
            const slotNewRef = doc(db, "availabilities", selectedNewSlot);
            const [slotOldSnap, slotNewSnap] = await Promise.all([getDoc(slotOldRef), getDoc(slotNewRef)]);
            const oldSlot = slotOldSnap.data();
            const newSlot = slotNewSnap.data();
            let apptData = null;
            try {
              const apptRef = doc(db, "appointments", editApptId);
              const apptSnap = await getDoc(apptRef);
              if (apptSnap.exists()) apptData = apptSnap.data();
            } catch (err) {
              console.warn("Errore recupero note:", err);
            }
            const notesText = apptData?.notes && apptData.notes.trim() ? apptData.notes.trim() : "Nessuna";
            const userEmail = user?.email || sessionStorage.getItem("clientEmail") || "email_non_disponibile";
            let clientFullName = sessionStorage.getItem("clientName") || userEmail;
            try {
              const qClient = query(collection(db, "clients"), where("email", "==", userEmail));
              const snapClient = await getDocs(qClient);
              if (!snapClient.empty) {
                const c = snapClient.docs[0].data();
                clientFullName = `${c.firstName || ""} ${c.lastName || ""}`.trim() || clientFullName;
              }
            } catch (err) {
              console.warn("Errore recupero nome cliente:", err);
            }
            const oldDate = new Date(toISO(oldSlot.start)).toLocaleDateString("it-IT");
            const oldTime = new Date(toISO(oldSlot.start)).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
            const newDate = new Date(toISO(newSlot.start)).toLocaleDateString("it-IT");
            const newTime = new Date(toISO(newSlot.start)).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
            const nameLine = (clientFullName !== userEmail) ? `üë§ Cliente: ${clientFullName}\nüìß Email: ${userEmail}` : `üë§ Cliente: ${userEmail}`;
            const msg = `‚úèÔ∏è Prenotazione modificata!
${nameLine}
üìù Note cliente: ${notesText}

üìÖ Vecchio appuntamento:
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${oldSlot.type || "Allenamento"}
üë®‚Äçüè´ Istruttore: ${oldSlot.instructor}
üïí Data: ${oldDate} alle ${oldTime}

üìÖ Nuovo appuntamento:
üèãÔ∏è‚Äç‚ôÇÔ∏è Attivit√†: ${newSlot.type || "Allenamento"}
üë®‚Äçüè´ Istruttore: ${newSlot.instructor}
üïí Data: ${newDate} alle ${newTime}`;
            await sendWhatsAppToStudio(msg);
            const trainerMsg = `‚úèÔ∏è Prenotazione modificata!
üë§ Cliente: ${clientFullName}
üìß Email: ${userEmail}
üìù Note cliente: ${notesText}

üìÖ Vecchio:
üèãÔ∏è‚Äç‚ôÇÔ∏è ${oldSlot.type || "Allenamento"}
üïí ${oldDate} alle ${oldTime}

üìÖ Nuovo:
üèãÔ∏è‚Äç‚ôÇÔ∏è ${newSlot.type || "Allenamento"}
üïí ${newDate} alle ${newTime}`;
            await sendWhatsAppToTrainer(newSlot.instructor, trainerMsg);
            console.log("‚úÖ Notifiche WhatsApp inviate dopo modifica");
          } catch (err) {
            console.error("‚ùå Errore invio WhatsApp (modifica):", err);
          }
          alert("Prenotazione aggiornata!");
          document.getElementById("editModal").classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        } catch (err) {
          alert(err.message);
        }
      });

     /* ========================================================= */
/* ADMIN + TRAINER: REPORT PDF                               */
/* ========================================================= */
document.getElementById("exportReportPDF")?.addEventListener("click", () => {
  try {
   const { jsPDF } = window.jspdf;
const doc = new jsPDF({ orientation: "landscape" });

    const instructor = document.getElementById("reportInstructorSelect")?.value || "ALL";
    const startDateRaw = document.getElementById("reportStartDate")?.value || "-";
    const endDateRaw = document.getElementById("reportEndDate")?.value || "-";

    const startDate = startDateRaw !== "-" ? new Date(startDateRaw).toLocaleDateString("it-IT") : "-";
    const endDate = endDateRaw !== "-" ? new Date(endDateRaw).toLocaleDateString("it-IT") : "-";

    doc.setFontSize(16);
    doc.text("Report Attivit√† Studio Personal Trainer", 14, 15);
    doc.setFontSize(10);
    doc.text(
      `Periodo: ${startDate} - ${endDate} | Istruttore: ${
        instructor === "ALL" ? "Tutti" : instructor
      }`,
      14,
      22
    );

    const rows = Array.from(document.querySelectorAll("#reportTableBody tr")).map(tr =>
      Array.from(tr.querySelectorAll("td")).map(td => td.innerText.trim())
    );

    if (!rows.length || rows[0][0].includes("Nessun")) {
      alert("‚ö†Ô∏è Nessun dato da esportare.");
      return;
    }

const headers = [[
  "Data",
  "Ora",
  "Istruttore",
  "Disciplina",
  "Posti",
  "Clienti",
  "Note cliente",
  "Note interne"
]];
    doc.autoTable({
      startY: 30,
      head: headers,
      body: rows,
      styles: { fontSize: 9 },
      headStyles: { fillColor: [22, 163, 74] },
    });

    const today = new Date().toISOString().slice(0, 10);
    doc.save(`report_${today}.pdf`);
  } catch (err) {
    console.error("Errore esportazione PDF:", err);
    alert("Errore durante la creazione del PDF.");
  }
});

/* ========================================================= */
/* ADMIN + TRAINER: REPORT                                   */
/* ========================================================= */
let reportReturnSection = "adminPanel";

/**
 * Popola il filtro istruttori.
 * Usa la collection "trainers" (campo name) invece delle availabilities,
 * cos√¨ vedi tutti gli istruttori registrati.
 *
 * @param {string} preselectName - (opzionale) nome da preselezionare
 */
async function populateReportInstructors(preselectName) {
  const select = document.getElementById("reportInstructorSelect");
  if (!select) return;

  try {
    const snap = await getDocs(collection(db, "trainers"));
    const names = snap.docs
      .map(d => (d.data().name || "").trim())
      .filter(Boolean)
      .sort((a, b) => a.localeCompare(b, "it-IT"));

    let html = `<option value="ALL">Tutti</option>`;
    html += names.map(n => `<option value="${n}">${n}</option>`).join("");
    select.innerHTML = html;

    // Se devo preselezionare un trainer specifico
    if (preselectName) {
      if (!names.includes(preselectName)) {
        const opt = new Option(preselectName, preselectName);
        select.add(opt);
      }
      select.value = preselectName;
    }
  } catch (err) {
    console.error("Errore caricamento istruttori per report:", err);
    // Fallback: almeno l'opzione "Tutti"
    select.innerHTML = `<option value="ALL">Tutti</option>`;
  }
}

// Apertura report da ADMIN (pu√≤ vedere tutti gli istruttori)
document.getElementById("openReport")?.addEventListener("click", async () => {
  reportReturnSection = "adminPanel";

  showSection("adminReport");
  await populateReportInstructors();   // nessun trainer pre-selezionato
  setDefaultReportDates();

  const select = document.getElementById("reportInstructorSelect");
  if (select) select.disabled = false; // admin pu√≤ cambiare

  loadReport();
});

// Apertura report da TRAINER (solo il trainer loggato)
document.getElementById("trainerOpenReport")?.addEventListener("click", async () => {
  const trainerName = document.getElementById("trainerNameLabel")?.textContent?.trim();
  if (!trainerName) {
    alert("Nome istruttore non trovato.");
    return;
  }

  reportReturnSection = "trainerPanel";

  showSection("adminReport");

  // popolo il filtro e preseleziono il trainer loggato
  await populateReportInstructors(trainerName);
  setDefaultReportDates();

  const select = document.getElementById("reportInstructorSelect");
  if (select) select.disabled = true; // il trainer NON pu√≤ cambiare istruttore

  loadReport();
});

// Il bottone "Torna al calendario" riporta alla sezione corretta
document.getElementById("backToCalendar")?.addEventListener("click", () => {
  showSection(reportReturnSection || "adminPanel");
});

// il pulsante "Carica Report" ricarica i dati (stesse regole per admin/trainer)
document.getElementById("loadReportBtn")?.addEventListener("click", () => loadReport());



      function setDefaultReportDates() {
        const startEl = document.getElementById("reportStartDate");
        const endEl = document.getElementById("reportEndDate");
        const today = new Date();
        const start = new Date(today);
        start.setDate(today.getDate() - today.getDay() + 1);
        const end = new Date(start);
        end.setDate(start.getDate() + 6);
        startEl.value = start.toISOString().slice(0, 10);
        endEl.value = end.toISOString().slice(0, 10);
      }

      async function loadReport() {
       const tbody = document.getElementById("reportTableBody");
tbody.innerHTML = `<tr><td colspan="8" class="p-3 text-center text-gray-500">Caricamento...</td></tr>`;
        const selectedInstructor = document.getElementById("reportInstructorSelect").value;
        const startDate = document.getElementById("reportStartDate").value;
        const endDate = document.getElementById("reportEndDate").value;
        if (!startDate || !endDate) {
          alert("Seleziona le date.");
          return;
        }
        const from = new Date(startDate + "T00:00:00");
        const to = new Date(endDate + "T23:59:59");
        try {
          const [snapAvail, snapAppt, snapClients] = await Promise.all([
            getDocs(query(collection(db, "availabilities"), where("deleted", "==", false))),
            getDocs(collection(db, "appointments")),
            getDocs(collection(db, "clients"))
          ]);
          const clientMap = {};
          snapClients.forEach(doc => {
            const c = doc.data();
            const full = `${c.firstName || ""} ${c.lastName || ""}`.trim();
            clientMap[c.email] = full || c.email;
          });
         const apptMap = {};
snapAppt.forEach(a => {
  const data = a.data();
  if (data.cancelled) return;
  const slotId = data.slotId;
  if (!apptMap[slotId]) apptMap[slotId] = [];
  apptMap[slotId].push({
    email: data.email,
    name: clientMap[data.email] || data.email,
    notes: (data.notes || "").trim(),
    adminNote: (data.adminNote || "").trim()
  });
});

          const filtered = [];
         snapAvail.forEach(d => {
  const v = withDefaults(d.data());
  const start = new Date(toISO(v.start));
  if (isNaN(start)) return;
  if (start < from || start > to) return;
  if (selectedInstructor !== "ALL" && v.instructor !== selectedInstructor) return;

  const slotAppts = apptMap[d.id] || [];

  const clienti = slotAppts.map(c => c.name);

  const noteClienti = slotAppts
    .filter(c => c.notes)
    .map(c => `${c.name}: ${c.notes}`);

  const noteInterne = slotAppts
    .filter(c => c.adminNote)
    .map(c => `${c.name}: ${c.adminNote}`);

  filtered.push({
    ...v,
    slotId: d.id,
    startDate: start,
    giorno: start.toLocaleDateString("it-IT", { weekday: 'long', day: '2-digit', month: '2-digit' }),
    ora: start.toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' }),
    clienti,
    noteClienti,
    noteInterne
  });
});

          filtered.sort((a, b) => a.startDate - b.startDate);
         const rows = filtered.map(v => `
  <tr>
    <td class="p-2 border">${v.giorno}</td>
    <td class="p-2 border">${v.ora}</td>
    <td class="p-2 border">${v.instructor}</td>
    <td class="p-2 border">${v.type || "-"}</td>
    <td class="p-2 border text-center">${v.bookedCount}/${v.maxSeats}</td>
    <td class="p-2 border">
      ${v.clienti && v.clienti.length ? v.clienti.join("<br>") : "Nessuno"}
    </td>
    <td class="p-2 border">
      ${v.noteClienti && v.noteClienti.length ? v.noteClienti.join("<br>") : "-"}
    </td>
    <td class="p-2 border">
      ${v.noteInterne && v.noteInterne.length ? v.noteInterne.join("<br>") : "-"}
    </td>
  </tr>
`);

          tbody.innerHTML = rows.length ? rows.join("") : `<tr><td colspan="8" class="p-3 text-center text-gray-500">Nessun dato disponibile.</td></tr>`;
        } catch (err) {
          console.error("Errore report:", err);
          tbody.innerHTML = `<tr><td colspan="6" class="p-3 text-center text-red-600">Errore nel caricamento.</td></tr>`;
        }
      }

      /* ========================================================= */
      /* ADMIN: GESTIONE ISTRUTTORI                                */
      /* ========================================================= */
      document.getElementById("openTrainersBtn")?.addEventListener("click", async () => {
        showSection("adminTrainers");
        await loadTrainers();
      });

      document.getElementById("backToAdminPanel")?.addEventListener("click", () => showSection("adminPanel"));

     document.getElementById("addTrainerBtn")?.addEventListener("click", async () => {
  const name = document.getElementById("newTrainerName").value.trim();
  const activitiesText = document.getElementById("newTrainerActivities").value.trim();
  const phone = document.getElementById("newTrainerPhone").value.trim();
  const apiKey = document.getElementById("newTrainerApiKey").value.trim();
  const email = document.getElementById("newTrainerEmail").value.trim();
  const password = document.getElementById("newTrainerPassword").value.trim();

  if (!name || !activitiesText || !apiKey || !email || !password) {
    return alert("‚ö†Ô∏è Compila tutti i campi obbligatori (compresi email e password).");
  }

  const activities = activitiesText.split(",").map(a => a.trim()).filter(a => a);

  try {
    // 1) CREA UTENTE AUTH (su app secondaria per non disconnettere l'admin)
    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, password);
    const uid = cred.user.uid;

    // 2) CREA DOC IN 'admins' CON RUOLO ISTRUTTORE
    await setDoc(doc(db, "admins", email), {
      role: "trainer",
      trainerName: name,
      trainerUid: uid,
      createdAt: new Date().toISOString()
    });

    // 3) CREA DOC IN 'trainers'
    await addDoc(collection(db, "trainers"), {
      name,
      activities,
      phone,
      apiKey,
      email,
      uid,
		allowAddBooking: true,
  allowAddSlot: true,
  allowDeleteSlot: true,
		allowMoveSlot: true,   
      createdAt: new Date().toISOString()
    });

    writeLog("create-trainer", "trainers", `Aggiunto istruttore: ${name} (${email})`);

    // 4) PULISCI I CAMPI
    document.getElementById("newTrainerName").value = "";
    document.getElementById("newTrainerActivities").value = "";
    document.getElementById("newTrainerPhone").value = "";
    document.getElementById("newTrainerApiKey").value = "";
    document.getElementById("newTrainerEmail").value = "";
    document.getElementById("newTrainerPassword").value = "";

    await loadTrainers();
    alert("‚úÖ Istruttore creato con successo.\n\nPu√≤ entrare nell'area admin usando email e password indicate.");
  } catch (err) {
    console.error("Errore aggiunta istruttore:", err);
    alert("‚ùå Errore nella creazione dell'istruttore: " + err.message);
  }
});


   async function loadTrainers() {
  const tbody = document.getElementById("trainersTableBody");
  tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-gray-500">Caricamento.</td></tr>`;
  const snap = await getDocs(collection(db, "trainers"));
  if (snap.empty) {
    tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-gray-500">Nessun istruttore.</td></tr>`;
    return;
  }
  tbody.innerHTML = "";
  snap.forEach(doc_ => {
    const data = doc_.data();
    const id = doc_.id;

    // default: se il campo non esiste, lo considero true
    const canAddBooking = data.allowAddBooking !== false;
    const canAddSlot    = data.allowAddSlot    !== false;
    const canDeleteSlot = data.allowDeleteSlot !== false;
	  const canMoveSlot   = data.allowMoveSlot   !== false; 

    tbody.innerHTML += `
      <tr>
        <td class="p-2 border">${data.name}</td>
        <td class="p-2 border">${(data.activities || []).join(", ")}</td>
        <td class="p-2 border">${data.phone || "-"}</td>
        <td class="p-2 border">${data.apiKey || "-"}</td>

        <!-- üîΩ PERMESSI -->
        <td class="p-2 border text-center">
          <input type="checkbox"
                 class="trainerPermToggle"
                 data-id="${id}"
                 data-perm="addBooking"
                 ${canAddBooking ? "checked" : ""} />
        </td>
        <td class="p-2 border text-center">
          <input type="checkbox"
                 class="trainerPermToggle"
                 data-id="${id}"
                 data-perm="addSlot"
                 ${canAddSlot ? "checked" : ""} />
        </td>
        <td class="p-2 border text-center">
          <input type="checkbox"
                 class="trainerPermToggle"
                 data-id="${id}"
                 data-perm="deleteSlot"
                 ${canDeleteSlot ? "checked" : ""} />
        </td>
<td class="p-2 border text-center">
      <input type="checkbox"
             class="trainerPermToggle"
             data-id="${id}"
             data-perm="moveSlot"
             ${canMoveSlot ? "checked" : ""} />
    </td>
        <!-- üîº PERMESSI -->

        <td class="p-2 border text-center">
          <button data-id="${id}" class="editTrainerBtn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">‚úèÔ∏è</button>
          <button data-id="${id}" class="deleteTrainerBtn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  // Listener DELETE istruttore (come prima)
  document.querySelectorAll(".deleteTrainerBtn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (!confirm("Eliminare questo istruttore?")) return;
      await deleteDoc(doc(db, "trainers", id));
      await loadTrainers();
    });
  });

  // Listener EDIT istruttore (come prima)
  document.querySelectorAll(".editTrainerBtn").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      const docSnap = await getDoc(doc(db, "trainers", id));
      if (!docSnap.exists()) return alert("Istruttore non trovato.");
      const d = docSnap.data();
      const newName = prompt("Nome istruttore:", d.name) || d.name;
      const newActs = prompt("Attivit√† (separate da virgola):", (d.activities || []).join(", ")) || d.activities.join(", ");
      const newPhone = prompt("Numero di telefono:", d.phone || "") || d.phone;
      const newApiKey = prompt("API Key:", d.apiKey || "") || d.apiKey;
      const newActivities = newActs.split(",").map(a => a.trim()).filter(a => a);
      await updateDoc(doc(db, "trainers", id), {
        name: newName,
        activities: newActivities,
        phone: newPhone,
        apiKey: newApiKey
      });
      await loadTrainers();
    });
  });

  // üî• Nuovi listener per i permessi
  document.querySelectorAll(".trainerPermToggle").forEach(chk => {
    chk.addEventListener("change", async (e) => {
      const id = e.target.dataset.id;
      const perm = e.target.dataset.perm;  // "addBooking" | "addSlot" | "deleteSlot"
      const value = e.target.checked;

      const fieldMap = {
        addBooking: "allowAddBooking",
        addSlot: "allowAddSlot",
        deleteSlot: "allowDeleteSlot",
		  moveSlot:   "allowMoveSlot"
      };

      const fieldName = fieldMap[perm];
      if (!fieldName) return;
      try {
        await updateDoc(doc(db, "trainers", id), {
          [fieldName]: value
        });
      } catch (err) {
        console.error("Errore update permessi istruttore:", err);
        alert("Errore nel salvataggio dei permessi.");
        // ripristino stato checkbox
        e.target.checked = !value;
      }
    });
  });
}

      /* ========================================================= */
      /* ADMIN: GESTIONE CLIENTI                                   */
      /* ========================================================= */
      document.getElementById("openClientsBtn")?.addEventListener("click", async () => {
        showSection("adminClients");
        await loadClients();
      });

      document.getElementById("backToAdminPanelFromClients")?.addEventListener("click", () => showSection("adminPanel"));

      let allClients = [];

      async function loadClients() {
        const tbody = document.getElementById("clientsTableBody");
        tbody.innerHTML = `<tr><td colspan="7" class="p-3 text-center text-gray-500">Caricamento...</td></tr>`;
        try {
          const snap = await getDocs(collection(db, "clients"));
          if (snap.empty) {
            tbody.innerHTML = `<tr><td colspan="7" class="p-3 text-center text-gray-500">Nessun cliente registrato.</td></tr>`;
            allClients = [];
            return;
          }
          allClients = snap.docs.map(doc => ({ id: doc.id, data: doc.data() }));
          renderClients(allClients);
        } catch (err) {
          console.error("Errore caricamento clienti:", err);
          tbody.innerHTML = `<tr><td colspan="7" class="p-3 text-center text-red-600">Errore nel caricamento clienti.</td></tr>`;
        }
      }

      function renderClients(clientsArray) {
        const tbody = document.getElementById("clientsTableBody");
        tbody.innerHTML = "";
        if (clientsArray.length === 0) {
          tbody.innerHTML = `<tr><td colspan="7" class="p-3 text-center text-gray-500">Nessun cliente trovato.</td></tr>`;
          return;
        }
        clientsArray.forEach(clientObj => {
          const { id, data } = clientObj;
          const regDate = data.createdAt ? new Date(data.createdAt).toLocaleDateString("it-IT") : "-";
          const status = data.status || "pending";
          const statusPill = status === "approved"
            ? `<span class="px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700">Approvato</span>`
            : `<span class="px-2 py-0.5 text-xs rounded-full bg-yellow-100 text-yellow-800">In attesa</span>`;
          const approveBtn = status === "approved" ? "" : `<button data-id="${id}" class="approveClientBtn bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">‚úîÔ∏è Approva</button>`;
          tbody.innerHTML += `
            <tr>
              <td class="p-2 border">${data.firstName || "-"}</td>
              <td class="p-2 border">${data.lastName || "-"}</td>
              <td class="p-2 border">${data.phone || "-"}</td>
              <td class="p-2 border">${data.email || "-"}</td>
              <td class="p-2 border text-center">${regDate}</td>
              <td class="p-2 border text-center">${statusPill}</td>
              <td class="p-2 border text-center space-x-1">
                <button data-id="${id}" data-name="${data.firstName} ${data.lastName}" class="viewClientBookingsBtn bg-teal-600 text-white px-2 py-1 rounded hover:bg-teal-700">üìÖ</button>
                ${approveBtn}
                <button data-id="${id}" class="editClientBtn bg-yellow-500 text-white px-2 py-1 rounded hover:bg-yellow-600">‚úèÔ∏è</button>
                <button data-id="${id}" class="deleteClientBtn bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">üóëÔ∏è</button>
              </td>
            </tr>
          `;
        });
        attachClientActionListeners();
      }

      function normalize(str) {
        return (str || "").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      }

      document.getElementById("searchClientInput")?.addEventListener("input", (e) => {
        const term = normalize(e.target.value.trim());
        if (!term) return renderClients(allClients);
        const filtered = allClients.filter(c => {
          const fn = normalize(c.data.firstName);
          const ln = normalize(c.data.lastName);
          return fn.includes(term) || ln.includes(term);
        });
        renderClients(filtered);
      });

      function attachClientActionListeners() {
        document.querySelectorAll(".deleteClientBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            if (!confirm("Vuoi davvero eliminare questo cliente?")) return;
            try {
              await deleteDoc(doc(db, "clients", id));
              alert("Cliente eliminato.");
              await loadClients();
            } catch (err) {
              console.error("Errore eliminazione:", err);
              alert("Errore durante eliminazione cliente.");
            }
          });
        });

        document.querySelectorAll(".editClientBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const id = e.target.dataset.id;
            const docSnap = await getDoc(doc(db, "clients", id));
            if (!docSnap.exists()) return alert("Cliente non trovato.");
            const c = docSnap.data();
            const newFirst = prompt("Nome:", c.firstName || "") || c.firstName;
            const newLast = prompt("Cognome:", c.lastName || "") || c.lastName;
            const newPhone = prompt("Telefono:", c.phone || "") || c.phone;
            try {
              await updateDoc(doc(db, "clients", id), {
                firstName: newFirst,
                lastName: newLast,
                phone: newPhone,
                modifiedAt: new Date().toISOString()
              });
              writeLog("edit-client", "clients", `Modificato cliente ${newFirst} ${newLast}`);
              alert("Cliente aggiornato.");
              await loadClients();
            } catch (err) {
              console.error("Errore aggiornamento:", err);
              alert("Errore durante l'aggiornamento.");
            }
          });
        });

        document.querySelectorAll(".viewClientBookingsBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const clientId = e.currentTarget.dataset.id;
            const clientName = e.currentTarget.dataset.name || "Cliente";
            const modal = document.getElementById("clientBookingsModal");
            const tbody = document.getElementById("clientBookingsTableBody");
            const title = document.getElementById("clientBookingsName");
            title.textContent = `Prenotazioni future di ${clientName}`;
            tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-gray-500">Caricamento...</td></tr>`;
            modal.classList.remove("hidden");
            document.body.classList.add("overflow-hidden");
            try {
              const clientSnap = await getDoc(doc(db, "clients", clientId));
              if (!clientSnap.exists()) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-red-600">Cliente non trovato.</td></tr>`;
                return;
              }
              const clientEmail = clientSnap.data().email;
              if (!clientEmail) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-red-600">Email mancante.</td></tr>`;
                return;
              }
              const qBookings = query(
                collection(db, "appointments"),
                where("email", "==", clientEmail),
                where("cancelled", "==", false)
              );
              const snapBookings = await getDocs(qBookings);
              const now = new Date();
              const future = [];
              snapBookings.forEach(d => {
                const v = d.data();
                const startISO = toISO(v.start);
                const startDate = new Date(startISO);
                if (!isNaN(startDate) && startDate > now) {
                  future.push({
                    start: startDate,
                    instructor: v.instructor || "-",
                    type: v.type || "-",
                    isGroup: v.isGroup === true
                  });
                }
              });
              if (future.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center">Nessuna futura prenotazione.</td></tr>`;
                return;
              }
              future.sort((a, b) => a.start - b.start);
              tbody.innerHTML = future.map(f => `
                <tr>
                  <td class="p-2 border">${f.start.toLocaleDateString("it-IT")}</td>
                  <td class="p-2 border">${f.start.toLocaleTimeString("it-IT", { hour: '2-digit', minute: '2-digit' })}</td>
                  <td class="p-2 border">${f.instructor}</td>
                  <td class="p-2 border">${f.type} <span class="text-xs text-gray-600">(${f.isGroup ? "Gruppo" : "Individuale"})</span></td>
                </tr>
              `).join("");
            } catch (err) {
              console.error("Errore prenotazioni:", err);
              tbody.innerHTML = `<tr><td colspan="9" class="p-3 text-center text-red-600">Errore caricamento.</td></tr>`;
            }
          });
        });

        document.getElementById("closeClientBookings")?.addEventListener("click", () => {
          document.getElementById("clientBookingsModal").classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        });
      }

      document.getElementById("clientsTableBody").addEventListener("click", async (e) => {
        const approveBtn = e.target.closest(".approveClientBtn");
        if (!approveBtn) return;
        const id = approveBtn.dataset.id;
        if (!confirm("Approvare questo cliente?")) return;
        try {
          approveBtn.disabled = true;
          await updateDoc(doc(db, "clients", id), {
            status: "approved",
            approvedAt: new Date().toISOString()
          });
          alert("Cliente approvato.");
          await loadClients();
        } catch (err) {
          console.error(err);
          alert("Errore approvazione: " + err.message);
        } finally {
          approveBtn.disabled = false;
        }
      });

      /* ========================================================= */
      /* ADMIN: LOGS                                               */
      /* ========================================================= */
      document.getElementById("openLogsBtn")?.addEventListener("click", async () => {
        showSection("adminLogs");
        const tbody = document.getElementById("logsTableBody");
        tbody.innerHTML = `<tr><td colspan="5" class="p-3 text-center text-gray-500">Caricamento...</td></tr>`;
        try {
          const snap = await getDocs(collection(db, "logs"));
          const logs = snap.docs.map(d => d.data());
          logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          tbody.innerHTML = logs.map(l => `
            <tr>
              <td class="p-2 border">${new Date(l.timestamp).toLocaleString("it-IT")}</td>
              <td class="p-2 border">${l.userEmail}</td>
              <td class="p-2 border">${l.actionType}</td>
              <td class="p-2 border">${l.section}</td>
              <td class="p-2 border">${l.details}</td>
            </tr>
          `).join("");
        } catch (err) {
          console.error("Errore caricamento log:", err);
          tbody.innerHTML = `<tr><td colspan="5" class="p-3 text-center text-red-500">Errore nel caricamento.</td></tr>`;
        }
      });

      document.getElementById("backToAdminFromLogs")?.addEventListener("click", () => showSection("adminPanel"));

      document.getElementById("clearLogsBtn")?.addEventListener("click", async () => {
        if (!confirm("Sei sicuro di voler cancellare TUTTI i log? L'operazione √® irreversibile.")) return;
        try {
          const logsCol = collection(db, "logs");
          const snap = await getDocs(logsCol);
          if (snap.empty) return alert("Nessun log da cancellare.");
          const deleteTasks = snap.docs.map(d => deleteDoc(doc(db, "logs", d.id)));
          await Promise.all(deleteTasks);
          alert("üìú Tutti i log sono stati cancellati.");
          const tbody = document.getElementById("logsTableBody");
          if (tbody) {
            tbody.innerHTML = `
              <tr>
                <td colspan="5" class="p-3 text-center text-gray-500">
                  Nessun log presente.
                </td>
              </tr>
            `;
          }
        } catch (err) {
          console.error("Errore durante la cancellazione dei log:", err);
          alert("‚ùå Errore nella cancellazione dei log.");
        }
      });

      /* ========================================================= */
      /* ADMIN: CANCELLA / SPOSTA PRENOTAZIONE                     */
      /* ========================================================= */
      document.getElementById("adminCancelAppt")?.addEventListener("click", async () => {
        const modal = document.getElementById("bookingDetailModal");
        const apptId = document.getElementById("adminApptSelector").value;
        const slotId = modal.dataset.slotId;
        if (!apptId || !slotId) return alert("Seleziona una prenotazione.");
        if (!confirm("Confermi cancellazione prenotazione selezionata?")) return;
        try {
          let bookingData = null;
          await runTransaction(db, async (transaction) => {
            const apptRef = doc(db, "appointments", apptId);
            const slotRef = doc(db, "availabilities", slotId);
            const apptSnap = await transaction.get(apptRef);
            const slotSnap = await transaction.get(slotRef);
            if (!apptSnap.exists()) throw new Error("Prenotazione non trovata.");
            if (!slotSnap.exists()) throw new Error("Slot non trovato.");
            const slot = withDefaults(slotSnap.data());
            const appt = apptSnap.data();
            bookingData = {
              phone: appt.phone || appt.userPhone || null,
              client: appt.client || appt.email || null,
              email: appt.email || null,
              date: toISO(slot.start).slice(0, 10),
              time: new Date(slot.start).toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" }),
              instructor: slot.instructor,
              type: slot.type || "Allenamento"
            };
            const newCount = Math.max(0, (slot.bookedCount || 0) - 1);
            transaction.update(apptRef, { cancelled: true });
            transaction.update(slotRef, {
              bookedCount: newCount,
              booked: newCount >= slot.maxSeats
            });
          });
          alert("Prenotazione cancellata.");
          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
          if (bookingData?.phone) {
            const message = `‚ùå Cancellazione confermata.
La tua prenotazione del ${bookingData.date} alle ${bookingData.time} con ${bookingData.instructor} √® stata annullata.`;
            await sendWhatsAppMessage(bookingData.phone, message);
          }
        } catch (err) {
          alert(err.message);
        }
      });

      /* ========================================================= */
      /* ADMIN: WHATSAPP                                           */
      /* ========================================================= */
      async function sendWhatsAppToStudio(message) {
        const studioPhone = "+393332438781";
        const apiKey = "7348173";
        const phoneClean = studioPhone.replace(/\+/g, "");
        const url = `https://api.callmebot.com/whatsapp.php?phone=${phoneClean}&text=${encodeURIComponent(message)}&apikey=${apiKey}`;
        try {
          const res = await fetch(url);
          const responseText = await res.text();
          console.log("üì© Risposta CallMeBot:", responseText);
          if (responseText.toLowerCase().includes("message sent")) {
            console.log("‚úÖ WhatsApp inviato allo studio");
          }
        } catch (err) {
          console.error("‚ùå Errore invio WhatsApp:", err);
        }
      }

      async function sendWhatsAppToTrainer(instructorName, message) {
        try {
          const qTrainer = query(collection(db, "trainers"), where("name", "==", instructorName));
          const snap = await getDocs(qTrainer);
          if (snap.empty) {
            console.warn("‚ö†Ô∏è Nessun istruttore trovato:", instructorName);
            return;
          }
          const trainer = snap.docs[0].data();
          const phone = trainer.phone?.trim();
          const apiKey = trainer.apiKey?.trim();
          if (!phone || !apiKey) {
            console.warn("‚ö†Ô∏è Istruttore senza telefono/API key:", instructorName);
            return;
          }
          const phoneClean = phone.replace(/\+/g, "");
          const url = `https://api.callmebot.com/whatsapp.php?phone=${phoneClean}&text=${encodeURIComponent(message)}&apikey=${apiKey}`;
          const res = await fetch(url);
          const responseText = await res.text();
          console.log(`üì© Risposta CallMeBot (${instructorName}):`, responseText);
        } catch (err) {
          console.error("‚ùå Errore invio WhatsApp istruttore:", err);
        }
      }

      /* ========================================================= */
      /* ADMIN: MODALI CHIUSURA                                    */
      /* ========================================================= */
      document.getElementById("closeBookingDetail")?.addEventListener("click", () => {
        document.getElementById("bookingDetailModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      });

      document.getElementById("bookingDetailModal")?.addEventListener("click", (e) => {
        if (e.target.id === "bookingDetailModal") {
          document.getElementById("bookingDetailModal").classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        }
      });

     /* ========================================================= */
/* ADMIN: SALVA NOTA INTERNA                                 */
/* ========================================================= */
document.getElementById("saveAdminInternalNote")?.addEventListener("click", async () => {
  const apptId = document.getElementById("adminApptSelector").value;
  if (!apptId) return alert("Seleziona una prenotazione dall'elenco.");
  const note = document.getElementById("adminInternalNote").value.trim();

  try {
    const apptRef = doc(db, "appointments", apptId);
    await updateDoc(apptRef, {
      adminNote: note,
      adminNoteUpdatedAt: new Date().toISOString()
    });

    alert("Nota salvata!");

    // üîÅ ricarico il calendario admin per aggiornare l'icona üìù sugli slot
    await initAdminCalendars();
  } catch (err) {
    console.error("Errore salvataggio nota:", err);
    alert("Errore durante il salvataggio della nota.");
  }
});

      /* ========================================================= */
      /* ADMIN: SPOSTA PRENOTAZIONE                                */
      /* ========================================================= */
      let adminMoveCal = null;
      let adminMoveTarget = null;

      function destroyMoveCal() {
        if (adminMoveCal) {
          adminMoveCal.destroy();
          adminMoveCal = null;
        }
      }

      document.getElementById("adminMoveAppt")?.addEventListener("click", async () => {
        const detail = document.getElementById("bookingDetailModal");
        const slotId = detail.dataset.slotId;
        if (!slotId) return;
        const slotSnap = await getDoc(doc(db, "availabilities", slotId));
        const v = withDefaults(slotSnap.data());
        const instructorSelect = document.getElementById("adminMoveInstructor");
        instructorSelect.innerHTML = `<option value="">Caricamento...</option>`;
        try {
          const snap = await getDocs(collection(db, "trainers"));
          const trainers = snap.docs.map(d => d.data().name);
          instructorSelect.innerHTML = `<option value="ALL">Tutti gli istruttori</option>` +
            trainers.map(t => `<option value="${t}" ${t === v.instructor ? "selected" : ""}>${t}</option>`).join("");
          instructorSelect.value = "ALL";
        } catch (err) {
          console.error("Errore caricamento istruttori:", err);
          instructorSelect.innerHTML = `<option value="">Errore</option>`;
        }
        document.getElementById("adminMoveDate").value = toISO(v.start).slice(0, 10);
        document.getElementById("adminMoveSelection").textContent = "Nessuno slot selezionato.";
        adminMoveTarget = null;
        document.getElementById("adminMoveModal").classList.remove("hidden");
        destroyMoveCal();
        initMoveCalendar();
      });

      function initMoveCalendar() {
        const date = document.getElementById("adminMoveDate").value;
        const inst = document.getElementById("adminMoveInstructor").value;
        const calEl = document.getElementById("adminMoveCalendar");
        if (!date || !inst) return;
        destroyMoveCal();
        adminMoveCal = new FullCalendar.Calendar(calEl, {
         initialView: defaultCalendarView,
handleWindowResize: true,
dayMaxEvents: true,
height: "auto",

          initialDate: date,
          allDaySlot: false,
          height: "auto",
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: "timeGridDay"
          },
          eventClick: (info) => {
            adminMoveCal.getEvents().forEach(ev => ev.setProp("color", "#16a34a"));
            info.event.setProp("color", "#2563eb");
            adminMoveTarget = info.event.id;
            document.getElementById("adminMoveSelection").textContent = `Nuovo slot: ${info.event.title} ‚Äî ${info.event.start.toLocaleString()}`;
          }
        });
        adminMoveCal.render();
        const q = query(collection(db, "availabilities"), where("deleted", "==", false));
        onSnapshot(q, (snap) => {
          adminMoveCal.removeAllEvents();
          snap.forEach(d => {
            const v = withDefaults(d.data());
            const s = toISO(v.start);
            const e = toISO(v.end);
            if (!s || !e) return;
            const sameDay = new Date(s).toISOString().slice(0, 10) === date;
            const rem = remainingSeats(v);
            if (sameDay && (inst === "ALL" || v.instructor === inst) && rem > 0) {
              adminMoveCal.addEvent({
                id: d.id,
                title: `${v.instructor} (${rem} liberi)`,
                start: s,
                end: e,
                color: "#16a34a"
              });
            }
          });
        });
      }

      document.getElementById("adminMoveInstructor").addEventListener("change", () => initMoveCalendar());
      document.getElementById("adminMoveLoadSlots")?.addEventListener("click", () => initMoveCalendar());
      document.getElementById("adminMoveCancel")?.addEventListener("click", () => {
        document.getElementById("adminMoveModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        destroyMoveCal();
      });

      document.getElementById("adminMoveConfirm")?.addEventListener("click", async () => {
        const apptId = document.getElementById("adminApptSelector").value;
        const detail = document.getElementById("bookingDetailModal");
        const oldSlotId = detail.dataset.slotId;
        if (!apptId || !oldSlotId || !adminMoveTarget) return alert("Seleziona slot e prenotazione.");
        try {
          await runTransaction(db, async (transaction) => {
            const apptRef = doc(db, "appointments", apptId);
            const oldRef = doc(db, "availabilities", oldSlotId);
            const newRef = doc(db, "availabilities", adminMoveTarget);
            const apptSnap = await transaction.get(apptRef);
            const oldSnap = await transaction.get(oldRef);
            const newSnap = await transaction.get(newRef);
            if (!apptSnap.exists()) throw new Error("Prenotazione non trovata.");
            if (!oldSnap.exists() || !newSnap.exists()) throw new Error("Slot non trovato.");
            const oldSlot = withDefaults(oldSnap.data());
            const newSlot = withDefaults(newSnap.data());
            if (remainingSeats(newSlot) <= 0) throw new Error("Nuovo slot pieno.");
            const updatedOldCount = Math.max(0, oldSlot.bookedCount - 1);
            const updatedNewCount = newSlot.bookedCount + 1;
            transaction.update(oldRef, {
              bookedCount: updatedOldCount,
              booked: updatedOldCount >= oldSlot.maxSeats
            });
            transaction.update(newRef, {
              bookedCount: updatedNewCount,
              booked: updatedNewCount >= newSlot.maxSeats
            });
            transaction.update(apptRef, {
              instructor: newSlot.instructor,
              start: toISO(newSlot.start),
              end: toISO(newSlot.end),
              slotId: adminMoveTarget,
              modifiedAt: new Date().toISOString()
            });
            writeLog("move-appointment", "appointments", `Spostato appuntamento ${apptId} da ${oldSlotId} a ${adminMoveTarget}`);
          });
          alert("Prenotazione spostata.");
          document.getElementById("adminMoveModal").classList.add("hidden");
          document.getElementById("bookingDetailModal").classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
          destroyMoveCal();
        } catch (err) {
          alert(err.message);
        }
      });

      /* ========================================================= */
      /* ADMIN: NUOVA PRENOTAZIONE MANUALE                         */
      /* ========================================================= */
      document.getElementById("adminNewBookingBtn")?.addEventListener("click", async () => {
        const modal = document.getElementById("adminNewBookingModal");
        modal.classList.remove("hidden");
        document.body.classList.add("overflow-hidden");
        await populateClientSelect();
        await populateInstructors(document.getElementById("adminBookingInstructorSelect"));
      });

      document.getElementById("adminBookingCancel")?.addEventListener("click", () => {
        document.getElementById("adminNewBookingModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
        if (adminBookingCal) adminBookingCal.destroy();
      });

      async function populateClientSelect() {
        const select = document.getElementById("adminBookingClientSelect");
        select.innerHTML = `<option>Caricamento...</option>`;
        try {
          const snap = await getDocs(collection(db, "clients"));
          const clients = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          select.innerHTML = `<option value="">-- Seleziona cliente --</option>` +
            clients.map(c => `<option value="${c.email}">${c.firstName} ${c.lastName} (${c.email})</option>`).join("");
        } catch (err) {
          console.error("Errore caricamento clienti:", err);
          select.innerHTML = `<option value="">Errore</option>`;
        }
      }

      let adminBookingCal = null;
      let selectedSlotForClient = null;

      document.getElementById("adminBookingLoadSlots")?.addEventListener("click", () => {
        const date = document.getElementById("adminBookingDate").value;
        const instructor = document.getElementById("adminBookingInstructorSelect").value;
        if (!date || !instructor) return alert("Seleziona data e istruttore.");
        const calEl = document.getElementById("adminBookingCalendar");
        calEl.innerHTML = "";
        if (adminBookingCal) adminBookingCal.destroy();
        adminBookingCal = new FullCalendar.Calendar(calEl, {
         initialView: defaultCalendarView,
handleWindowResize: true,
dayMaxEvents: true,
height: "auto",

          initialDate: date,
          allDaySlot: false,
          height: "auto",
          locale: "it",
          firstDay: 1,
          slotMinTime: "07:00:00",
          slotMaxTime: "22:00:00",
          slotLabelFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
          eventTimeFormat: { hour: "2-digit", minute: "2-digit", hour12: false },
          headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: ""
          },
          eventClick: (info) => {
            adminBookingCal.getEvents().forEach(ev => ev.setProp("color", "#16a34a"));
            info.event.setProp("color", "#2563eb");
            selectedSlotForClient = info.event.id;
          }
        });
        adminBookingCal.render();
        const q = query(collection(db, "availabilities"), where("deleted", "==", false));
        onSnapshot(q, (snap) => {
          adminBookingCal.removeAllEvents();
          snap.forEach((d) => {
            const v = withDefaults(d.data());
            const start = toISO(v.start);
            const end = toISO(v.end);
            if (!start || !end) return;
            const isSameDay = new Date(start).toISOString().slice(0, 10) === date;
            const rem = remainingSeats(v);
            if (isSameDay && (instructor === "ALL" || v.instructor === instructor) && rem > 0) {
              adminBookingCal.addEvent({
                id: d.id,
                title: `${v.instructor} ‚Äì ${v.type || "Allenamento"} (${rem} liberi su ${v.maxSeats})`,
                start,
                end,
                color: "#16a34a"
              });
            }
          });
        });
      });

      document.getElementById("adminBookingConfirm")?.addEventListener("click", async () => {
        const email = document.getElementById("adminBookingClientSelect").value;
        if (!email || !selectedSlotForClient) return alert("Seleziona cliente e slot.");
        const slotRef = doc(db, "availabilities", selectedSlotForClient);
        try {
          await runTransaction(db, async (transaction) => {
            const sSnap = await transaction.get(slotRef);
            if (!sSnap.exists()) throw new Error("Slot non trovato.");
            const slot = withDefaults(sSnap.data());
            if (slot.bookedCount >= slot.maxSeats) throw new Error("Slot pieno.");
            transaction.update(slotRef, {
              bookedCount: slot.bookedCount + 1,
              booked: (slot.bookedCount + 1) >= slot.maxSeats
            });
            const newApptRef = doc(collection(db, "appointments"));
            transaction.set(newApptRef, {
              client: email,
              email,
              instructor: slot.instructor,
              type: slot.type,
              start: toISO(slot.start),
              end: toISO(slot.end),
              slotId: selectedSlotForClient,
              cancelled: false,
              createdAt: new Date().toISOString()
            });
          });
          alert("‚úÖ Prenotazione creata con successo!");
          document.getElementById("adminNewBookingModal").classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      });

      /* ========================================================= */
      /* ADMIN: SLOT LIBERO                                        */
      /* ========================================================= */
      document.getElementById("freeSlotCancel")?.addEventListener("click", () => {
        document.getElementById("freeSlotModal").classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      });

      document.getElementById("freeSlotDelete")?.addEventListener("click", async () => {
        const modal = document.getElementById("freeSlotModal");
        const slotId = modal.dataset.slotId;
        if (!confirm("Vuoi davvero eliminare questo slot?")) return;
        try {
          await updateDoc(doc(db, "availabilities", slotId), { deleted: true });
          alert("‚úÖ Slot eliminato.");
          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        } catch (err) {
          alert("Errore durante l'eliminazione dello slot: " + err.message);
        }
      });

      document.getElementById("freeSlotBook")?.addEventListener("click", async () => {
        const modal = document.getElementById("freeSlotModal");
        const slotId = modal.dataset.slotId;
        const email = document.getElementById("freeSlotClientSelect").value;
        if (!email) return alert("Seleziona un cliente.");
        const slotRef = doc(db, "availabilities", slotId);
        try {
          await runTransaction(db, async (transaction) => {
            const sSnap = await transaction.get(slotRef);
            if (!sSnap.exists()) throw new Error("Slot non trovato.");
            const slot = withDefaults(sSnap.data());
            if (slot.bookedCount >= slot.maxSeats) throw new Error("Slot pieno.");
            transaction.update(slotRef, {
              bookedCount: slot.bookedCount + 1,
              booked: (slot.bookedCount + 1) >= slot.maxSeats
            });
            const newApptRef = doc(collection(db, "appointments"));
            transaction.set(newApptRef, {
              client: email,
              email,
              instructor: slot.instructor,
              type: slot.type,
              start: toISO(slot.start),
              end: toISO(slot.end),
              slotId,
              cancelled: false,
              createdAt: new Date().toISOString()
            });
          });
          alert("‚úÖ Prenotazione aggiunta correttamente!");
          modal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      });

      /* ========================================================= */
      /* FORMATTAZIONE LOG                                         */
      /* ========================================================= */
      function formatSlotLog(slot, customAction) {
        const instructor = slot.instructor || "-";
        const activity = slot.type || "-";
        const isGroup = slot.maxSeats > 1 ? "GRUPPO" : "INDIVIDUALE";
        const start = new Date(slot.start);
        const date = start.toLocaleDateString("it-IT");
        const time = start.toLocaleTimeString("it-IT", { hour: "2-digit", minute: "2-digit" });
        return `${customAction}: ${instructor} ‚Ä¢ ${activity} ‚Ä¢ ${isGroup} ‚Ä¢ ${date} ${time}`;
      }
    });

    /* ========================================================= */
    /* ADMIN: WHATSAPP MESSAGE                                   */
    /* ========================================================= */
    async function sendWhatsAppMessage(phone, message) {
      // Placeholder per invio diretto a cliente se necessario
      console.warn("‚ö†Ô∏è Invio WhatsApp al cliente non implementato. Numero:", phone, "Messaggio:", message);
    }
	  
	  // CHIUSURA MODALE ISTRUTTORE
document.getElementById("trainerSlotClose")?.addEventListener("click", () => {
  const modal = document.getElementById("trainerSlotModal");
  modal.classList.add("hidden");
  document.body.classList.remove("overflow-hidden");
});

// SALVATAGGIO PRENOTAZIONE DA ISTRUTTORE
const trainerAddBtn = document.getElementById("trainerSlotAddBtn");

if (trainerAddBtn) {
  trainerAddBtn.addEventListener("click", async (event) => {
    event.preventDefault();

    console.log("CLICK su trainerSlotAddBtn");
 const perms = window.trainerPermissions || { addBooking: true };

    // üîê Usa i permessi letti da Firestore (allowAddBooking)
    if (!trainerPermissions.addBooking) {
      alert("Non hai i permessi per aggiungere prenotazioni.");
      return;
    }

    const modal   = document.getElementById("trainerSlotModal");
    const slotId  = modal.dataset.slotId;
    const select  = document.getElementById("trainerAddBookingClient");
    const notesEl = document.getElementById("trainerAddBookingNotes");

    const email = select.value;
    const notes = notesEl.value.trim();

    if (!slotId) {
      alert("Slot non valido.");
      return;
    }

    if (!email) {
      alert("Seleziona un cliente.");
      return;
    }

    const slotRef = doc(db, "availabilities", slotId);

    try {
      await runTransaction(db, async (transaction) => {
        const sSnap = await transaction.get(slotRef);
        if (!sSnap.exists()) {
          throw new Error("Slot non trovato.");
        }

        const slot = withDefaults(sSnap.data());

        if (slot.bookedCount >= slot.maxSeats) {
          throw new Error("Slot pieno.");
        }

        // Aggiorno lo slot
        transaction.update(slotRef, {
          bookedCount: slot.bookedCount + 1,
          booked: (slot.bookedCount + 1) >= slot.maxSeats
        });

        // Creo l'appuntamento
        const newApptRef = doc(collection(db, "appointments"));
        transaction.set(newApptRef, {
          client: email,
          email,
          instructor: slot.instructor,
          type: slot.type || "Allenamento",
          start: toISO(slot.start),
          end: toISO(slot.end),
          slotId,
          notes: notes || "",
          fromTrainer: true,
          cancelled: false,
          createdAt: new Date().toISOString()
        });
      });

      alert("‚úÖ Prenotazione aggiunta con successo!");
      modal.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    } catch (err) {
      console.error("Errore aggiunta prenotazione istruttore:", err);
      alert("‚ùå Errore: " + err.message);
    }
  });
} else {
  console.warn("trainerSlotAddBtn non trovato nel DOM");
}


/* ----------------------------------------------------------
   CANCELLAZIONE SLOT (istruttore, solo se vuoto)
---------------------------------------------------------- */
document.getElementById("trainerSlotClose")?.addEventListener("click", () => {
  document.getElementById("trainerSlotModal").classList.add("hidden");
  document.body.classList.remove("overflow-hidden");
});

document.getElementById("trainerDeleteSlotBtn")?.addEventListener("click", async () => {
  const modal = document.getElementById("trainerSlotModal");
  const slotId = modal.dataset.slotId;
  if (!slotId) return;

  // controlliamo che sia vuoto
  const apptSnap = await getDocs(
    query(collection(db, "appointments"), where("slotId", "==", slotId), where("cancelled", "==", false))
  );
  if (!apptSnap.empty) {
    alert("‚ùå Non puoi eliminare uno slot con prenotazioni attive.");
    return;
  }

  if (!confirm("Sei sicuro di voler eliminare questo slot?")) return;

  try {
    // soft-delete
    await updateDoc(doc(db, "availabilities", slotId), { deleted: true });
    alert("‚úÖ Slot eliminato.");
    modal.classList.add("hidden");
    document.body.classList.remove("overflow-hidden");
  } catch (err) {
    console.error("Errore eliminazione slot:", err);
    alert("‚ùå Errore durante l‚Äôeliminazione.");
  }
});
	  
  </script>
	
	<!-- ========================= ADMIN: MODALE CREAZIONE SLOT ========================= -->
<div id="slotCreationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg max-w-md w-full space-y-4">
    <h2 class="text-lg font-semibold text-green-700">Crea nuovo slot</h2>

    <div>
      <label class="block mb-1 font-semibold">Istruttore</label>
      <select id="adminModalInstructorSelect" class="w-full p-2 border rounded">
        <option value="">Seleziona istruttore</option>
      </select>
    </div>

    <div>
      <label class="block mb-1 font-semibold">Attivit√†</label>
      <select id="adminModalActivitySelect" class="w-full p-2 border rounded">
        <option value="">Seleziona attivit√†</option>
      </select>
    </div>

    <div>
      <label class="block mb-1 font-semibold">Durata (minuti)</label>
      <input type="number" id="modalDuration" class="w-full p-2 border rounded" placeholder="Es. 60" min="1">
    </div>

    <div>
      <label class="block mb-1 font-semibold">Numero massimo partecipanti</label>
      <input type="number" id="modalMaxSeats" class="w-full p-2 border rounded" placeholder="Es. 1" min="1">
    </div>

    <div class="flex justify-end space-x-2">
      <button id="modalCancelBtn" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
      <button id="modalCreateBtn" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Crea slot</button>
    </div>
  </div>
</div>
	
<!-- ========= TRAINER: CREA SLOT RAPIDO ========= -->
<div id="trainerQuickSlotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg max-w-md w-full space-y-4">
    <h2 class="text-lg font-semibold text-green-700">Crea slot</h2>

    <!-- Discipline -->
    <div>
      <label class="block mb-1 font-semibold">Disciplina</label>
      <select id="trainerQuickDiscipline" class="w-full p-2 border rounded" required>
        <option value="">-- carico discipline --</option>
      </select>
    </div>

    <!-- Durata -->
    <div>
      <label class="block mb-1 font-semibold">Durata (minuti)</label>
      <input type="number" id="trainerQuickDuration" class="w-full p-2 border rounded" value="60" min="15" step="15" required>
    </div>

    <!-- Posti -->
    <div>
      <label class="block mb-1 font-semibold">Max partecipanti</label>
      <input type="number" id="trainerQuickMaxSeats" class="w-full p-2 border rounded" placeholder="Es. 1" min="1" required>
    </div>

    <div class="flex justify-end space-x-2">
      <button id="trainerQuickCancel" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">Annulla</button>
      <button id="trainerQuickSave" class="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">Crea</button>
    </div>
  </div>
  </div>
	
	<footer id="mainFooter" class="py-6 mt-10 text-center text-white text-sm">
  <div>¬© 2025 FitWeb ‚Äì Tutti i diritti riservati</div>
  <img
    id="footerLogo"
    alt="Logo FitWeb"
    style="width: 120px; height: auto; margin: 8px auto 0; opacity: 0.9; display: block;"
    src="data:image/jpeg;base64,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"
  />
</footer>


	
</body>
</html>
